<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="author" content="Ben Kyriakou">
<title>The Complete Drupal Widget Guide</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="book">
<div id="header">
<h1>The Complete Drupal Widget Guide</h1>
<div class="details">
<span id="author" class="author">Ben Kyriakou</span><br>
<span id="email" class="email"><a href="mailto:ben@benkyriakou.com">ben@benkyriakou.com</a></span><br>
<span id="revnumber">version 0.1</span>
</div>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_preface">1. Preface</a></li>
<li><a href="#_preface_2">2. Preface</a></li>
<li><a href="#_what_are_widgets">3. What are Widgets?</a></li>
<li><a href="#_what_are_widgets_2">4. What are Widgets?</a>
<ul class="sectlevel2">
<li><a href="#_fieldtype">4.1. FieldType</a></li>
<li><a href="#_fieldformatter">4.2. FieldFormatter</a></li>
<li><a href="#_fieldwidget">4.3. FieldWidget</a></li>
</ul>
</li>
<li><a href="#_a_basic_widget">5. A basic Widget</a></li>
<li><a href="#_a_basic_widget_2">6. A basic Widget</a></li>
<li><a href="#_adding_an_ajax_button">7. Adding an AJAX button</a></li>
<li><a href="#_settings">8. Settings</a></li>
<li><a href="#_generating_widgets_with_drupal_console">9. Generating widgets with Drupal console</a></li>
<li><a href="#_how_do_widgets_work">10. How do widgets work?</a></li>
<li><a href="#_how_do_settings_work">11. How do settings work?</a></li>
<li><a href="#_how_does_form_ajax_work">12. How does form AJAX work?</a></li>
<li><a href="#_third_party_settings">13. Third-party settings</a>
<ul class="sectlevel2">
<li><a href="#_the_api">13.1. The API</a></li>
<li><a href="#_the_implementation">13.2. The implementation</a></li>
</ul>
</li>
<li><a href="#_appendix">14. Appendix</a>
<ul class="sectlevel2">
<li><a href="#_form_api_primer">14.1. Form API primer</a></li>
<li><a href="#_render_element_primer">14.2. Render element primer</a></li>
<li><a href="#_ddev_environment">14.3. ddev environment</a></li>
</ul>
</li>
<li><a href="#_errata">15. Errata</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_preface">1. Preface</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_preface_2">2. Preface</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I’ve been developing for Drupal 8 for about three years now and, whilst it’s been a marked improvement from Drupal 7 in many ways, I’ve often found myself looking for documentation that doesn’t exist. After numerous expeditions into the Drupal source code I started documenting my findings in blog posts, partly for my own memory and partly to help others having the same issue.</p>
</div>
<div class="paragraph">
<p>At a certain point this felt like it needed a more thorough treatment&#8212;&#8203;how many others were struggling through the core APIs and being held back by the lack of comprehensive documentation? Whilst there are lots of great ebooks already out there, most cover development at a high level rather than diving into a particular part of the API in detail.</p>
</div>
<div class="paragraph">
<p>This is my aim with this publication&#8212;&#8203;to not only give you the information you need to create a widget, but also to explore the API in enough detail that you’re comfortable venturing outside the limits of the code herein to create your own, more advanced, widgets with confidence.</p>
</div>
<div class="paragraph">
<p>So come along with me, on a journey through the widget API and beyond.</p>
</div>
<div class="paragraph">
<p>I should note at this point that this was written (and all code was tested) against Drupal 8.9.x, which is the current Drupal version at the time of writing. However, I&#8217;m confident that this code will be equally applicable to Drupal 9 given the widget API has not changed&#8212;&#8203;the <code>WidgetInterface</code> is exactly the same, and <code>WidgetBase</code> has lost a single trait.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_what_are_widgets">3. What are Widgets?</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_what_are_widgets_2">4. What are Widgets?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I’m assuming that if you’re here you already have at least some idea of what a widget is and why you want to make one&#8212;&#8203;if that’s the case, feel free to skip to the next chapter. If not, have a read.</p>
</div>
<div class="paragraph">
<p>Widgets are part of the triumvirate of core field Plugins, formed of <a href="https://www.drupal.org/docs/8/api/entity-api/fieldtypes-fieldwidgets-and-fieldformatters"><code>FieldType</code>, <code>FieldFormatter</code>, and <code>FieldWidget</code></a>. The roles of these plugins are as follows:</p>
</div>
<div class="sect2">
<h3 id="_fieldtype">4.1. FieldType</h3>
<div class="paragraph">
<p>A <code><strong>FieldType</strong></code> defines the structure and schema of a particular type of field&#8212;&#8203;for example, a text or date field. It doesn’t know anything about how you enter the information for the field, or how it looks on the front-end, just how it stores and processes data.</p>
</div>
</div>
<div class="sect2">
<h3 id="_fieldformatter">4.2. FieldFormatter</h3>
<div class="paragraph">
<p>A <code><strong>FieldFormatter</strong></code> defines the front-end appearance for one or more
<code><strong>FieldTypes</strong></code>. You can have more than one formatter for a type, and if they’re similar enough a formatter can span multiple types (although most only cater to a single type). The contract between the formatter and type is the data structure the type defines - the formatter then takes the data the field returns when being displayed and performs the necessary operations to show it to the user (escaping data, wrapping it in a theme template, etc.).</p>
</div>
</div>
<div class="sect2">
<h3 id="_fieldwidget">4.3. FieldWidget</h3>
<div class="paragraph">
<p>A <code><strong>FieldWidget</strong></code> defines the back-end interface for one or more
<code><strong>FieldTypes</strong></code>. This is the form that an admin user will edit the field with, and as with <code><strong>FieldFormatters</strong></code> a type often has multiple widgets available. These can be as simple as a single text input for a plain-text field, or as complex as a JavaScript-drivenz widget for a date repeat field.</p>
</div>
<div class="paragraph">
<p>Ultimately the contract that the widget has with the type is the same as the formatter&#8212;&#8203;the structure of the data that the type expects to save in the database. This means that, whatever the front-end interface of the widget, it must return data in the same format that the type defines to be able to save it into the database (and subsequently return it for display with the formatter)</p>
</div>
<div class="paragraph">
<p>So the reason to make a widget might be that you’re defining a new field type and you want to give users a way to enter data or, more commonly, you want to add a new way for a user to interact with an existing field type. You also might not be defining an entirely new widget, and instead you just want to alter the behaviour of an existing widget (or widgets). Don’t worry - we’ll cover that too.</p>
</div>
<div class="paragraph">
<p>So that’s the use-case for this ebook. Now carry on to find out how to do it!</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_a_basic_widget">5. A basic Widget</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_a_basic_widget_2">6. A basic Widget</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So let’s start getting into the interesting bits first&#8212;&#8203;how to make a widget. The code below is written against Drupal 8, but since the API hasn’t changed in Drupal 9 at the time of writing I’d expect it all to be forwards-compatible. If you run into any issues, see the errata section for more information.</p>
</div>
<div class="paragraph">
<p>Widgets are an example of a Drupal Plugin, which means we need to create and annotate a particular class. To get started we&#8217;re going to use Drupal console to generate a module, since the topic of this book isn&#8217;t creating modules. We could also create the <code>FieldWidget</code> using Drupal Console, but at this stage I&#8217;d prefer to walk through the process so that you&#8217;re aware of all of the steps&#8212;&#8203;later on I&#8217;ll demonstrate how to do this more quickly with Drupal Console.</p>
</div>
<div class="paragraph">
<p>To get started, let’s generate a module to add our widget to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="text"><span></span>&gt; ddev drupal generate:module

 // Welcome to the Drupal module generator

 Enter the new module name:
 &gt; Example widget

 Enter the module machine name [example_widget]:
 &gt;

 Enter the module Path [modules/custom]:
 &gt;

 Enter module description [My Awesome Module]:
 &gt; A module for my example widget

 Enter package name [Custom]:
 &gt;

 Enter Drupal Core version [8.x]:
 &gt;

 Do you want to generate a .module file? (yes/no) [yes]:
 &gt; yes

 Define module as feature (yes/no) [no]:
 &gt; no

 Do you want to add a composer.json file to your module? (yes/no) [yes]:
 &gt; no

 Would you like to add module dependencies? (yes/no) [no]:
 &gt; yes

 Module dependencies separated by commas (i.e. context, panels):
 &gt; text

 Do you want to generate a unit test class? (yes/no) [yes]:
 &gt; no

 Do you want to generate a themeable template? (yes/no) [yes]:
 &gt; no

 Do you want proceed with the operation? (yes/no) [yes]:
 &gt; yes</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will generate a basic module structure like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="text"><span></span>web/modules/custom/
└── example_widget
     ├── example_widget.info.yml
     └── example_widget.module</code></pre>
</div>
</div>
<div class="paragraph">
<p>We also want to create the directories our Plugin code will live in. The Drupal autoloader will look for classes in the <code>src</code> directory of modules, so that will be our first level. Next the FieldWidget is a <code>Plugin</code>, and it&#8217;s a <code>Field</code> plugin of type <code>FieldWidget</code>, so we end up with this structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="text"><span></span>web/modules/custom/
└── example_widget/
    ├── example_widget.info.yml
    ├── example_widget.module
    └── src
        └── Plugin
            └── Field
                └── FieldWidget</code></pre>
</div>
</div>
<div class="paragraph">
<p>Inside this directory we can then create our plugin file. Let&#8217;s call our widget class <code>ExampleTextFieldWidget</code>, so for <a href="https://www.drupal.org/docs/develop/standards/psr-4-namespaces-and-autoloading-in-drupal-8">compatibility with PSR-4</a> we need the file to have the same name. Inside that file we can create our widget plugin class;</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-o">&lt;?</span><span class="tok-nx">php</span>

<span class="tok-k">namespace</span> <span class="tok-nx">Drupal\example_widget\Plugin\Field\FieldWidget</span><span class="tok-p">;</span>

<span class="tok-k">use</span> <span class="tok-nx">Drupal\Core\Field\WidgetBase</span><span class="tok-p">;</span>

<span class="tok-k">class</span> <span class="tok-nc">ExampleTextFieldWidget</span> <span class="tok-k">extends</span> <span class="tok-nx">WidgetBase</span> <span class="tok-p">{</span>

<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To let Drupal recognise this as a plugin we have to add the <a href="https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Core%21Field%21Annotation%21FieldWidget.php/class/FieldWidget/8.9.x">appropriate annotation</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-o">&lt;?</span><span class="tok-nx">php</span>

<span class="tok-k">namespace</span> <span class="tok-nx">Drupal\example_widget\Plugin\Field\FieldWidget</span><span class="tok-p">;</span>

<span class="tok-k">use</span> <span class="tok-nx">Drupal\Core\Field\WidgetBase</span><span class="tok-p">;</span>

<span class="tok-sd">/**</span>
<span class="tok-sd"> * Plugin implementation of the &#39;example_text_field_widget&#39; widget.</span>
<span class="tok-sd"> *</span>
<span class="tok-sd"> * @FieldWidget(</span>
<span class="tok-sd"> *   id = &quot;example_text_field_widget&quot;,</span>
<span class="tok-sd"> *   module = &quot;example_widget&quot;,</span>
<span class="tok-sd"> *   label = @Translation(&quot;Example text field widget&quot;),</span>
<span class="tok-sd"> *   field_types = {</span>
<span class="tok-sd"> *     &quot;string&quot;</span>
<span class="tok-sd"> *   }</span>
<span class="tok-sd"> * )</span>
<span class="tok-sd"> */</span>
<span class="tok-k">class</span> <span class="tok-nc">ExampleTextFieldWidget</span> <span class="tok-k">extends</span> <span class="tok-nx">WidgetBase</span> <span class="tok-p">{</span>

<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We also have to implement the only <code>WidgetInterface</code> method that isn&#8217;t covered by <code>WidgetBase</code>--<code>formElement()</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-o">&lt;?</span><span class="tok-nx">php</span>

<span class="tok-k">namespace</span> <span class="tok-nx">Drupal\example_widget\Plugin\Field\FieldWidget</span><span class="tok-p">;</span>

<span class="tok-k">use</span> <span class="tok-nx">Drupal\Core\Field\WidgetBase</span><span class="tok-p">;</span>
<span class="tok-k">use</span> <span class="tok-nx">Drupal\Core\Form\FormStateInterface</span><span class="tok-p">;</span>
<span class="tok-k">use</span> <span class="tok-nx">Drupal\Core\Field\FieldItemListInterface</span><span class="tok-p">;</span>

<span class="tok-sd">/**</span>
<span class="tok-sd"> * Plugin implementation of the &#39;example_text_field_widget&#39; widget.</span>
<span class="tok-sd"> *</span>
<span class="tok-sd"> * @FieldWidget(</span>
<span class="tok-sd"> *   id = &quot;example_text_field_widget&quot;,</span>
<span class="tok-sd"> *   module = &quot;example_widget&quot;,</span>
<span class="tok-sd"> *   label = @Translation(&quot;Example text field widget&quot;),</span>
<span class="tok-sd"> *   field_types = {</span>
<span class="tok-sd"> *     &quot;string&quot;</span>
<span class="tok-sd"> *   }</span>
<span class="tok-sd"> * )</span>
<span class="tok-sd"> */</span>
<span class="tok-k">class</span> <span class="tok-nc">ExampleTextFieldWidget</span> <span class="tok-k">extends</span> <span class="tok-nx">WidgetBase</span> <span class="tok-p">{</span>

  <span class="tok-sd">/**</span>
<span class="tok-sd">   * {@inheritdoc}</span>
<span class="tok-sd">   */</span>
  <span class="tok-k">public</span> <span class="tok-k">function</span> <span class="tok-nf">formElement</span><span class="tok-p">(</span><span class="tok-nx">FieldItemListInterface</span> <span class="tok-nv">$items</span><span class="tok-p">,</span> <span class="tok-nv">$delta</span><span class="tok-p">,</span> <span class="tok-k">array</span> <span class="tok-nv">$element</span><span class="tok-p">,</span> <span class="tok-k">array</span> <span class="tok-o">&amp;</span><span class="tok-nv">$form</span><span class="tok-p">,</span> <span class="tok-nx">FormStateInterface</span> <span class="tok-nv">$form_state</span><span class="tok-p">)</span><span class="tok-o">:</span> <span class="tok-k">array</span> <span class="tok-p">{</span>
    <span class="tok-k">return</span> <span class="tok-p">[];</span>
  <span class="tok-p">}</span>

<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is now a valid enough Widget plugin that you can enable it for a field&#8212;&#8203;enable the module with <code>ddev drush moi example_widget</code> (or <code>ddev drush en example_widget</code>) if you&#8217;re using an older version of Drush, and create a new <strong>Text (plain)</strong> field on a node bundle. On the <strong>Manage Form Display</strong> tab you will see your new Widget available as <strong>Example text field widget</strong>--you can enable it if you want, but right now you won&#8217;t see anything output if you edit the node. Let&#8217;s deal with that next.</p>
</div>
<div class="paragraph">
<p>Since this is a widget for a text field, we want to add some kind of element we can enter text in. Let&#8217;s create a simple textfield:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-o">&lt;?</span><span class="tok-nx">php</span>

<span class="tok-k">namespace</span> <span class="tok-nx">Drupal\example_widget\Plugin\Field\FieldWidget</span><span class="tok-p">;</span>

<span class="tok-k">use</span> <span class="tok-nx">Drupal\Core\Field\WidgetBase</span><span class="tok-p">;</span>
<span class="tok-k">use</span> <span class="tok-nx">Drupal\Core\Form\FormStateInterface</span><span class="tok-p">;</span>
<span class="tok-k">use</span> <span class="tok-nx">Drupal\Core\Field\FieldItemListInterface</span><span class="tok-p">;</span>

<span class="tok-sd">/**</span>
<span class="tok-sd"> * Plugin implementation of the &#39;example_text_field_widget&#39; widget.</span>
<span class="tok-sd"> *</span>
<span class="tok-sd"> * @FieldWidget(</span>
<span class="tok-sd"> *   id = &quot;example_text_field_widget&quot;,</span>
<span class="tok-sd"> *   module = &quot;example_widget&quot;,</span>
<span class="tok-sd"> *   label = @Translation(&quot;Example text field widget&quot;),</span>
<span class="tok-sd"> *   field_types = {</span>
<span class="tok-sd"> *     &quot;string&quot;</span>
<span class="tok-sd"> *   }</span>
<span class="tok-sd"> * )</span>
<span class="tok-sd"> */</span>
<span class="tok-k">class</span> <span class="tok-nc">ExampleTextFieldWidget</span> <span class="tok-k">extends</span> <span class="tok-nx">WidgetBase</span> <span class="tok-p">{</span>

  <span class="tok-sd">/**</span>
<span class="tok-sd">   * {@inheritdoc}</span>
<span class="tok-sd">   */</span>
  <span class="tok-k">public</span> <span class="tok-k">function</span> <span class="tok-nf">formElement</span><span class="tok-p">(</span><span class="tok-nx">FieldItemListInterface</span> <span class="tok-nv">$items</span><span class="tok-p">,</span> <span class="tok-nv">$delta</span><span class="tok-p">,</span> <span class="tok-k">array</span> <span class="tok-nv">$element</span><span class="tok-p">,</span> <span class="tok-k">array</span> <span class="tok-o">&amp;</span><span class="tok-nv">$form</span><span class="tok-p">,</span> <span class="tok-nx">FormStateInterface</span> <span class="tok-nv">$form_state</span><span class="tok-p">)</span><span class="tok-o">:</span> <span class="tok-k">array</span> <span class="tok-p">{</span>
    <span class="tok-nv">$element</span><span class="tok-p">[</span><span class="tok-s1">&#39;value&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
      <span class="tok-s1">&#39;#type&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;textfield&#39;</span><span class="tok-p">,</span>
      <span class="tok-s1">&#39;#title&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">t</span><span class="tok-p">(</span><span class="tok-s1">&#39;Text&#39;</span><span class="tok-p">),</span>
      <span class="tok-s1">&#39;#default_value&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$items</span><span class="tok-p">[</span><span class="tok-nv">$delta</span><span class="tok-p">]</span><span class="tok-o">-&gt;</span><span class="tok-na">value</span> <span class="tok-o">??</span> <span class="tok-s1">&#39;&#39;</span><span class="tok-p">,</span>
    <span class="tok-p">];</span>

    <span class="tok-k">return</span> <span class="tok-nv">$element</span><span class="tok-p">;</span>
  <span class="tok-p">}</span>

<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you now edit the field you created that uses this widget, you&#8217;ll be able to edit and save text, but it doesn&#8217;t show up in the field when you go to edit it (although it will appear on the front-end). We need to add a default value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-o">&lt;?</span><span class="tok-nx">php</span>

<span class="tok-k">namespace</span> <span class="tok-nx">Drupal\example_widget\Plugin\Field\FieldWidget</span><span class="tok-p">;</span>

<span class="tok-k">use</span> <span class="tok-nx">Drupal\Core\Field\WidgetBase</span><span class="tok-p">;</span>
<span class="tok-k">use</span> <span class="tok-nx">Drupal\Core\Form\FormStateInterface</span><span class="tok-p">;</span>
<span class="tok-k">use</span> <span class="tok-nx">Drupal\Core\Field\FieldItemListInterface</span><span class="tok-p">;</span>

<span class="tok-sd">/**</span>
<span class="tok-sd"> * Plugin implementation of the &#39;example_text_field_widget&#39; widget.</span>
<span class="tok-sd"> *</span>
<span class="tok-sd"> * @FieldWidget(</span>
<span class="tok-sd"> *   id = &quot;example_text_field_widget&quot;,</span>
<span class="tok-sd"> *   module = &quot;example_widget&quot;,</span>
<span class="tok-sd"> *   label = @Translation(&quot;Example text field widget&quot;),</span>
<span class="tok-sd"> *   field_types = {</span>
<span class="tok-sd"> *     &quot;string&quot;</span>
<span class="tok-sd"> *   }</span>
<span class="tok-sd"> * )</span>
<span class="tok-sd"> */</span>
<span class="tok-k">class</span> <span class="tok-nc">ExampleTextFieldWidget</span> <span class="tok-k">extends</span> <span class="tok-nx">WidgetBase</span> <span class="tok-p">{</span>

  <span class="tok-sd">/**</span>
<span class="tok-sd">   * {@inheritdoc}</span>
<span class="tok-sd">   */</span>
  <span class="tok-k">public</span> <span class="tok-k">function</span> <span class="tok-nf">formElement</span><span class="tok-p">(</span><span class="tok-nx">FieldItemListInterface</span> <span class="tok-nv">$items</span><span class="tok-p">,</span> <span class="tok-nv">$delta</span><span class="tok-p">,</span> <span class="tok-k">array</span> <span class="tok-nv">$element</span><span class="tok-p">,</span> <span class="tok-k">array</span> <span class="tok-o">&amp;</span><span class="tok-nv">$form</span><span class="tok-p">,</span> <span class="tok-nx">FormStateInterface</span> <span class="tok-nv">$form_state</span><span class="tok-p">)</span><span class="tok-o">:</span> <span class="tok-k">array</span> <span class="tok-p">{</span>
    <span class="tok-nv">$element</span><span class="tok-p">[</span><span class="tok-s1">&#39;value&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
      <span class="tok-s1">&#39;#type&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;textfield&#39;</span><span class="tok-p">,</span>
      <span class="tok-s1">&#39;#title&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">t</span><span class="tok-p">(</span><span class="tok-s1">&#39;Text&#39;</span><span class="tok-p">),</span>
      <span class="tok-s1">&#39;#default_value&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$items</span><span class="tok-p">[</span><span class="tok-nv">$delta</span><span class="tok-p">]</span><span class="tok-o">-&gt;</span><span class="tok-na">value</span> <span class="tok-o">??</span> <span class="tok-s1">&#39;&#39;</span><span class="tok-p">,</span>
    <span class="tok-p">];</span>

    <span class="tok-k">return</span> <span class="tok-nv">$element</span><span class="tok-p">;</span>
  <span class="tok-p">}</span>

<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you can edit the page, give the field a value, save it, and see it reflected in your widget to edit again. Congratulations&#8212;&#8203;you&#8217;ve made your first <code>FieldWidget</code>!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_adding_an_ajax_button">7. Adding an AJAX button</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Because widget forms are standalone elements of a larger form, the general method of interacting with them using buttons is via AJAX actions. It is possible to add handlers to the parent form, but we then have to deal with the whole form array rather than the specific part we’re interested in for the widget, and isn&#8217;t a standard way of interacting with them in core.</p>
</div>
<div class="paragraph">
<p>Before doing any more on this, it’s worth a quick recap of the <a href="https://www.drupal.org/docs/drupal-apis/javascript-api/ajax-forms">form AJAX API</a>, since it’s something that not everyone uses a lot (myself included).</p>
</div>
<div class="paragraph">
<p>AJAX events can be added to any element that creates an event, with the general format:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-s1">&#39;#ajax&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-p">[</span>
    <span class="tok-s1">&#39;callback&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;::myAjaxCallback&#39;</span><span class="tok-p">,</span> <span class="tok-c1">// don&#39;t forget :: when calling a class method.</span>
    <span class="tok-c1">//&#39;callback&#39; =&gt; [$this, &#39;myAjaxCallback&#39;], //alternative notation</span>
    <span class="tok-s1">&#39;disable-refocus&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-k">FALSE</span><span class="tok-p">,</span> <span class="tok-c1">// Or TRUE to prevent re-focusing on the triggering element.</span>
    <span class="tok-s1">&#39;event&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;change&#39;</span><span class="tok-p">,</span>
    <span class="tok-s1">&#39;wrapper&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;edit-output&#39;</span><span class="tok-p">,</span> <span class="tok-c1">// This element is updated with this AJAX callback.</span>
    <span class="tok-s1">&#39;progress&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-p">[</span>
      <span class="tok-s1">&#39;type&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;throbber&#39;</span><span class="tok-p">,</span>
      <span class="tok-s1">&#39;message&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">t</span><span class="tok-p">(</span><span class="tok-s1">&#39;Verifying entry...&#39;</span><span class="tok-p">),</span>
    <span class="tok-p">],</span>
  <span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>See <a href="https://www.drupal.org/docs/drupal-apis/ajax-api/basic-concepts#sub_form">the AJAX form API documentation</a> for a full list of properties that can be applied to an <code>#ajax</code> attribute.</p>
</div>
<div class="paragraph">
<p>Note that an <code>#ajax</code> attribute can only have a single callback, unlike a property like <code>#submit</code> where we can attach an array of callbacks. All other callback notation applies though, so we can either attach the callback to a static class method, a method on an existing object instance, or a regular function.</p>
</div>
<div class="paragraph">
<p>We pick the event that invokes the callback, along with some properties of the AJAX response - for example, whether the element is refocussed after the callback is executed, what the progress indicator is, and what ID the element to update has.</p>
</div>
<div class="paragraph">
<p>The callback function is expected to return an <code>AjaxResponse</code>, which contains one or more commands - see <a href="https://www.drupal.org/docs/drupal-apis/ajax-api/core-ajax-callback-commands">the AJAX commands documentation</a> for a full list of the available commands. These can replace HTML, add CSS, display an alert, and many other common AJAX actions. Alternatively, you can create your own command plugin that implements the <code>CommandInterface</code>, a subject which is beyond the scope of this guide.</p>
</div>
<div class="paragraph">
<p>Essentially an <code>AjaxResponse</code> is a way of packaging a set of pre-defined configurable JavaScript actions to be executed in the DOM.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s add a basic button that tells us how long the text in the field is. First we need to add a button to the output of <code>formElement()</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-nv">$element</span><span class="tok-p">[</span><span class="tok-s1">&#39;value&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
  <span class="tok-s1">&#39;#type&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;textfield&#39;</span><span class="tok-p">,</span>
  <span class="tok-s1">&#39;#title&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">t</span><span class="tok-p">(</span><span class="tok-s1">&#39;Text&#39;</span><span class="tok-p">),</span>
  <span class="tok-s1">&#39;#default_value&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$items</span><span class="tok-p">[</span><span class="tok-nv">$delta</span><span class="tok-p">]</span><span class="tok-o">-&gt;</span><span class="tok-na">value</span> <span class="tok-o">??</span> <span class="tok-s1">&#39;&#39;</span><span class="tok-p">,</span>
<span class="tok-p">];</span>

<span class="tok-nv">$element</span><span class="tok-p">[</span><span class="tok-s1">&#39;submit&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
  <span class="tok-s1">&#39;#type&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;submit&#39;</span><span class="tok-p">,</span>
  <span class="tok-s1">&#39;#value&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">t</span><span class="tok-p">(</span><span class="tok-s1">&#39;Check length&#39;</span><span class="tok-p">),</span>
<span class="tok-p">]</span>

<span class="tok-k">return</span> <span class="tok-nv">$element</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we have a button, but it doesn&#8217;t do much. Let&#8217;s give it an AJAX handler:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-nv">$element</span><span class="tok-p">[</span><span class="tok-s1">&#39;value&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
  <span class="tok-s1">&#39;#type&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;textfield&#39;</span><span class="tok-p">,</span>
  <span class="tok-s1">&#39;#title&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">t</span><span class="tok-p">(</span><span class="tok-s1">&#39;Text&#39;</span><span class="tok-p">),</span>
  <span class="tok-s1">&#39;#default_value&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$items</span><span class="tok-p">[</span><span class="tok-nv">$delta</span><span class="tok-p">]</span><span class="tok-o">-&gt;</span><span class="tok-na">value</span> <span class="tok-o">??</span> <span class="tok-s1">&#39;&#39;</span><span class="tok-p">,</span>
<span class="tok-p">];</span>

<span class="tok-nv">$element</span><span class="tok-p">[</span><span class="tok-s1">&#39;submit&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
  <span class="tok-s1">&#39;#type&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;submit&#39;</span><span class="tok-p">,</span>
  <span class="tok-s1">&#39;#value&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">t</span><span class="tok-p">(</span><span class="tok-s1">&#39;Check length&#39;</span><span class="tok-p">),</span>
  <span class="tok-s1">&#39;#ajax&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-p">[</span>
    <span class="tok-s1">&#39;callback&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-p">[</span><span class="tok-nv">$this</span><span class="tok-p">,</span> <span class="tok-s1">&#39;doAjax&#39;</span><span class="tok-p">],</span>
    <span class="tok-s1">&#39;progress&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-p">[</span>
      <span class="tok-s1">&#39;type&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;throbber&#39;</span><span class="tok-p">,</span>
      <span class="tok-s1">&#39;message&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">t</span><span class="tok-p">(</span><span class="tok-s1">&#39;Counting characters...&#39;</span><span class="tok-p">),</span>
    <span class="tok-p">],</span>
  <span class="tok-p">],</span>
<span class="tok-p">];</span>

<span class="tok-k">return</span> <span class="tok-nv">$element</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Rather than add a callback like <code>[static::class, 'doAjax']</code> where I&#8217;d have to use a static class, I&#8217;ve used <code>$this</code> so that I can call out to <code>$this&#8594;t()</code> within my method. We can&#8217;t invoke the method using the double colon syntax like <code>['::doAjax']</code> because it would get invoked on the form object, and the method is attached to the Widget class.</p>
</div>
<div class="paragraph">
<p>Now we also need to add our AJAX callback method to the class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-k">public</span> <span class="tok-k">function</span> <span class="tok-nf">doAjax</span><span class="tok-p">(</span><span class="tok-k">array</span> <span class="tok-nv">$form</span><span class="tok-p">,</span> <span class="tok-nx">FormStateInterface</span> <span class="tok-nv">$form_state</span><span class="tok-p">)</span> <span class="tok-p">{</span>

<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>AJAX handlers must return an <code>AjaxResponse</code> with one or more AJAX commands to execute actions on the front-end. Let&#8217;s add a simple <code>OpenModalDialogCommand</code> to show us the field count:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-k">public</span> <span class="tok-k">function</span> <span class="tok-nf">doAjax</span><span class="tok-p">(</span><span class="tok-k">array</span> <span class="tok-nv">$form</span><span class="tok-p">,</span> <span class="tok-nx">FormStateInterface</span> <span class="tok-nv">$form_state</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nv">$triggering_element</span> <span class="tok-o">=</span> <span class="tok-nv">$form_state</span><span class="tok-o">-&gt;</span><span class="tok-na">getTriggeringElement</span><span class="tok-p">();</span>
  <span class="tok-nv">$parents</span> <span class="tok-o">=</span> <span class="tok-nb">array_slice</span><span class="tok-p">(</span><span class="tok-nv">$triggering_element</span><span class="tok-p">[</span><span class="tok-s1">&#39;#parents&#39;</span><span class="tok-p">],</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-p">);</span>
  <span class="tok-nv">$value</span> <span class="tok-o">=</span> <span class="tok-nv">$form_state</span><span class="tok-o">-&gt;</span><span class="tok-na">getValue</span><span class="tok-p">(</span><span class="tok-nb">array_merge</span><span class="tok-p">(</span><span class="tok-nv">$parents</span><span class="tok-p">,</span> <span class="tok-p">[</span><span class="tok-s1">&#39;value&#39;</span><span class="tok-p">]));</span>

  <span class="tok-nv">$message</span> <span class="tok-o">=</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">t</span><span class="tok-p">(</span><span class="tok-s1">&#39;The message is @count characters long&#39;</span><span class="tok-p">,</span> <span class="tok-p">[</span><span class="tok-s1">&#39;@count&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nb">mb_strlen</span><span class="tok-p">(</span><span class="tok-nv">$value</span><span class="tok-p">)]);</span>
  <span class="tok-nv">$response</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">AjaxResponse</span><span class="tok-p">();</span>
  <span class="tok-nv">$response</span><span class="tok-o">-&gt;</span><span class="tok-na">addCommand</span><span class="tok-p">(</span><span class="tok-k">new</span> <span class="tok-nx">OpenModalDialogCommand</span><span class="tok-p">(</span><span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">t</span><span class="tok-p">(</span><span class="tok-s1">&#39;Message count&#39;</span><span class="tok-p">),</span> <span class="tok-nv">$message</span><span class="tok-p">));</span>
  <span class="tok-k">return</span> <span class="tok-nv">$response</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We also need to add the dialog library as an attachment to our form:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-nv">$element</span><span class="tok-p">[</span><span class="tok-s1">&#39;#attached&#39;</span><span class="tok-p">][</span><span class="tok-s1">&#39;library&#39;</span><span class="tok-p">][]</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;core/drupal.dialog.ajax&#39;</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This now shows us an alert with the number of characters in the field.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/dialog.png" alt="The modal dialog containing the character count"></span></p>
</div>
<div class="paragraph">
<p>Our complete widget code is now:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-o">&lt;?</span><span class="tok-nx">php</span>

<span class="tok-k">namespace</span> <span class="tok-nx">Drupal\example_widget\Plugin\Field\FieldWidget</span><span class="tok-p">;</span>

<span class="tok-k">use</span> <span class="tok-nx">Drupal\Core\Ajax\AjaxResponse</span><span class="tok-p">;</span>
<span class="tok-k">use</span> <span class="tok-nx">Drupal\Core\Ajax\OpenModalDialogCommand</span><span class="tok-p">;</span>
<span class="tok-k">use</span> <span class="tok-nx">Drupal\Core\Field\FieldItemListInterface</span><span class="tok-p">;</span>
<span class="tok-k">use</span> <span class="tok-nx">Drupal\Core\Field\WidgetBase</span><span class="tok-p">;</span>
<span class="tok-k">use</span> <span class="tok-nx">Drupal\Core\Form\FormStateInterface</span><span class="tok-p">;</span>

<span class="tok-sd">/**</span>
<span class="tok-sd"> * Plugin implementation of the &#39;example_text_field_widget&#39; widget.</span>
<span class="tok-sd"> *</span>
<span class="tok-sd"> * @FieldWidget(</span>
<span class="tok-sd"> *   id = &quot;example_widget_basic_widget&quot;,</span>
<span class="tok-sd"> *   module = &quot;example_widget&quot;,</span>
<span class="tok-sd"> *   label = @Translation(&quot;Basic text field widget&quot;),</span>
<span class="tok-sd"> *   field_types = {</span>
<span class="tok-sd"> *     &quot;string&quot;</span>
<span class="tok-sd"> *   }</span>
<span class="tok-sd"> * )</span>
<span class="tok-sd"> */</span>
<span class="tok-k">class</span> <span class="tok-nc">BasicWidgetExample</span> <span class="tok-k">extends</span> <span class="tok-nx">WidgetBase</span> <span class="tok-p">{</span>

  <span class="tok-sd">/**</span>
<span class="tok-sd">   * {@inheritdoc}</span>
<span class="tok-sd">   */</span>
  <span class="tok-k">public</span> <span class="tok-k">function</span> <span class="tok-nf">formElement</span><span class="tok-p">(</span><span class="tok-nx">FieldItemListInterface</span> <span class="tok-nv">$items</span><span class="tok-p">,</span> <span class="tok-nv">$delta</span><span class="tok-p">,</span> <span class="tok-k">array</span> <span class="tok-nv">$element</span><span class="tok-p">,</span> <span class="tok-k">array</span> <span class="tok-o">&amp;</span><span class="tok-nv">$form</span><span class="tok-p">,</span> <span class="tok-nx">FormStateInterface</span> <span class="tok-nv">$form_state</span><span class="tok-p">)</span><span class="tok-o">:</span> <span class="tok-k">array</span> <span class="tok-p">{</span>
    <span class="tok-nv">$element</span><span class="tok-p">[</span><span class="tok-s1">&#39;value&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
      <span class="tok-s1">&#39;#type&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;textfield&#39;</span><span class="tok-p">,</span>
      <span class="tok-s1">&#39;#title&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">t</span><span class="tok-p">(</span><span class="tok-s1">&#39;Text&#39;</span><span class="tok-p">),</span>
      <span class="tok-s1">&#39;#default_value&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$items</span><span class="tok-p">[</span><span class="tok-nv">$delta</span><span class="tok-p">]</span><span class="tok-o">-&gt;</span><span class="tok-na">value</span> <span class="tok-o">??</span> <span class="tok-s1">&#39;&#39;</span><span class="tok-p">,</span>
    <span class="tok-p">];</span>

    <span class="tok-nv">$element</span><span class="tok-p">[</span><span class="tok-s1">&#39;submit&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
      <span class="tok-s1">&#39;#type&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;submit&#39;</span><span class="tok-p">,</span>
      <span class="tok-s1">&#39;#value&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">t</span><span class="tok-p">(</span><span class="tok-s1">&#39;Check length&#39;</span><span class="tok-p">),</span>
      <span class="tok-s1">&#39;#ajax&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-p">[</span>
        <span class="tok-s1">&#39;callback&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-p">[</span><span class="tok-nv">$this</span><span class="tok-p">,</span> <span class="tok-s1">&#39;doAjax&#39;</span><span class="tok-p">],</span>
        <span class="tok-s1">&#39;progress&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-p">[</span>
          <span class="tok-s1">&#39;type&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;throbber&#39;</span><span class="tok-p">,</span>
          <span class="tok-s1">&#39;message&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">t</span><span class="tok-p">(</span><span class="tok-s1">&#39;Counting characters...&#39;</span><span class="tok-p">),</span>
        <span class="tok-p">],</span>
      <span class="tok-p">],</span>
    <span class="tok-p">];</span>

    <span class="tok-nv">$element</span><span class="tok-p">[</span><span class="tok-s1">&#39;#attached&#39;</span><span class="tok-p">][</span><span class="tok-s1">&#39;library&#39;</span><span class="tok-p">][]</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;core/drupal.dialog.ajax&#39;</span><span class="tok-p">;</span>

    <span class="tok-k">return</span> <span class="tok-nv">$element</span><span class="tok-p">;</span>
  <span class="tok-p">}</span>

  <span class="tok-sd">/**</span>
<span class="tok-sd">   * AJAX handler.</span>
<span class="tok-sd">   *</span>
<span class="tok-sd">   * @param array $form</span>
<span class="tok-sd">   *   The form array.</span>
<span class="tok-sd">   * @param FormStateInterface $form_state</span>
<span class="tok-sd">   *   The form state.</span>
<span class="tok-sd">   *</span>
<span class="tok-sd">   * @return AjaxResponse</span>
<span class="tok-sd">   *   A series of commands to be executed.</span>
<span class="tok-sd">   */</span>
  <span class="tok-k">public</span> <span class="tok-k">function</span> <span class="tok-nf">doAjax</span><span class="tok-p">(</span><span class="tok-k">array</span> <span class="tok-nv">$form</span><span class="tok-p">,</span> <span class="tok-nx">FormStateInterface</span> <span class="tok-nv">$form_state</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-nv">$triggering_element</span> <span class="tok-o">=</span> <span class="tok-nv">$form_state</span><span class="tok-o">-&gt;</span><span class="tok-na">getTriggeringElement</span><span class="tok-p">();</span>
    <span class="tok-nv">$parents</span> <span class="tok-o">=</span> <span class="tok-nb">array_slice</span><span class="tok-p">(</span><span class="tok-nv">$triggering_element</span><span class="tok-p">[</span><span class="tok-s1">&#39;#parents&#39;</span><span class="tok-p">],</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-p">);</span>
    <span class="tok-nv">$value</span> <span class="tok-o">=</span> <span class="tok-nv">$form_state</span><span class="tok-o">-&gt;</span><span class="tok-na">getValue</span><span class="tok-p">(</span><span class="tok-nb">array_merge</span><span class="tok-p">(</span><span class="tok-nv">$parents</span><span class="tok-p">,</span> <span class="tok-p">[</span><span class="tok-s1">&#39;value&#39;</span><span class="tok-p">]));</span>

    <span class="tok-nv">$message</span> <span class="tok-o">=</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">t</span><span class="tok-p">(</span><span class="tok-s1">&#39;The message is @count characters long&#39;</span><span class="tok-p">,</span> <span class="tok-p">[</span><span class="tok-s1">&#39;@count&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nb">mb_strlen</span><span class="tok-p">(</span><span class="tok-nv">$value</span><span class="tok-p">)]);</span>
    <span class="tok-nv">$response</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">AjaxResponse</span><span class="tok-p">();</span>
    <span class="tok-nv">$response</span><span class="tok-o">-&gt;</span><span class="tok-na">addCommand</span><span class="tok-p">(</span><span class="tok-k">new</span> <span class="tok-nx">OpenModalDialogCommand</span><span class="tok-p">(</span><span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">t</span><span class="tok-p">(</span><span class="tok-s1">&#39;Message count&#39;</span><span class="tok-p">),</span> <span class="tok-nv">$message</span><span class="tok-p">));</span>
    <span class="tok-k">return</span> <span class="tok-nv">$response</span><span class="tok-p">;</span>
  <span class="tok-p">}</span>

<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s a basic example of a widget AJAX button with callback. All we had to add was:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A <code>submit</code> element with an <code>#ajax</code> callback</p>
</li>
<li>
<p>A corresponding method on the Widget class</p>
</li>
<li>
<p>An <code>AjaxResponse</code> containing one or more AJAX commands</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_settings">8. Settings</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now we have a basic widget that offers character counts for our field. But what if we want to make the widget configurable? Maybe sometimes we want to have character counts for a field, and other times we want word counts.</p>
</div>
<div class="paragraph">
<p>This is where some of the methods that are implemented on <code>WidgetBase</code> will need to be overridden. To add basic settings we need four things:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A settings schema to be used by the form</p>
</li>
<li>
<p>A default value for the setting</p>
</li>
<li>
<p>A form to change the setting for the field</p>
</li>
<li>
<p>A summary of the settings to show on the field admin page</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Let&#8217;s implement these in order.</p>
</div>
<div class="paragraph">
<p>To create a schema for our widget settings, we first need to create a <a href="https://www.drupal.org/docs/drupal-apis/configuration-api/configuration-schemametadata">configuration schema file</a> for our module. In <code>example_widget/config/schema</code>, create a file called <code>example_widget.schema.yml</code>. As per <a href="https://www.drupal.org/docs/creating-custom-modules/creating-custom-field-types-widgets-and-formatters/create-a-custom-0#s-step-2-create-the-configuration-schema-for-the-settings-youve-created">the widget documentation</a> we then need to create a schema for our widget of the format <code>field.widget.settings.[WIDGET ID]</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yml"><span></span>field.widget.settings.example_widget_basic_widget:
  type: mapping
  label: &#39;Example basic field widget settings&#39;
  mapping:
    count_type:
      type: text
      label: &#39;Count type&#39;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This creates a basic schema with a text field corresponding to our settingm which we&#8217;ve called <code>count_type</code>. If you&#8217;re interested in more of the specifics on the naming of this schema, or how it gets used, see the advanced settings section.</p>
</div>
<div class="paragraph">
<p>Next the default settings. This uses, unsurprisingly, the <code>defaultSettings()</code> method of <code>WidgetInterface</code>. Let&#8217;s assume we have two types of count available, 'letter' and 'word':</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-sd">/**</span>
<span class="tok-sd">* {@inheritdoc}</span>
<span class="tok-sd">*/</span>
<span class="tok-k">public</span> <span class="tok-k">static</span> <span class="tok-k">function</span> <span class="tok-nf">defaultSettings</span><span class="tok-p">()</span><span class="tok-o">:</span> <span class="tok-k">array</span> <span class="tok-p">{</span>
    <span class="tok-k">return</span> <span class="tok-p">[</span>
        <span class="tok-s1">&#39;count_type&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;letter&#39;</span><span class="tok-p">,</span>
    <span class="tok-p">]</span> <span class="tok-o">+</span> <span class="tok-k">parent</span><span class="tok-o">::</span><span class="tok-na">defaultSettings</span><span class="tok-p">();</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we override the <code>defaultSettings</code> method, adding a new default settings value called <code>'count_type'</code> in addition to the settings values from the parent field&#8212;&#8203;in our case not entirely necessary since the implementation of <code>defaultSettings</code> on <code>WidgetBase</code> is blank, but important if we were extending another text field widget which offers some additional settings.</p>
</div>
<div class="paragraph">
<p>Now we need to add a form to allow the administrator to manipulate our settings. Since we have a setting that has a set of fixed values, of which we need the user to pick one, let&#8217;s go with a <code>select</code> element:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-sd">/**</span>
<span class="tok-sd">* {@inheritdoc}</span>
<span class="tok-sd">*/</span>
<span class="tok-k">public</span> <span class="tok-k">function</span> <span class="tok-nf">settingsForm</span><span class="tok-p">(</span><span class="tok-k">array</span> <span class="tok-nv">$form</span><span class="tok-p">,</span> <span class="tok-nx">FormStateInterface</span> <span class="tok-nv">$form_state</span><span class="tok-p">)</span><span class="tok-o">:</span> <span class="tok-k">array</span> <span class="tok-p">{</span>
    <span class="tok-nv">$elements</span> <span class="tok-o">=</span> <span class="tok-p">[];</span>

    <span class="tok-nv">$elements</span><span class="tok-p">[</span><span class="tok-s1">&#39;count_type&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
        <span class="tok-s1">&#39;#type&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;select&#39;</span><span class="tok-p">,</span>
        <span class="tok-s1">&#39;#title&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nx">t</span><span class="tok-p">(</span><span class="tok-s1">&#39;Count type&#39;</span><span class="tok-p">),</span>
        <span class="tok-s1">&#39;#default_value&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">getSetting</span><span class="tok-p">(</span><span class="tok-s1">&#39;count_type&#39;</span><span class="tok-p">),</span>
        <span class="tok-s1">&#39;#options&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-p">[</span>
            <span class="tok-s1">&#39;letter&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">t</span><span class="tok-p">(</span><span class="tok-s1">&#39;Letter&#39;</span><span class="tok-p">),</span>
            <span class="tok-s1">&#39;word&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">t</span><span class="tok-p">(</span><span class="tok-s1">&#39;Word&#39;</span><span class="tok-p">),</span>
        <span class="tok-p">],</span>
    <span class="tok-p">];</span>

    <span class="tok-k">return</span> <span class="tok-nv">$elements</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we have something that&#8217;s visible in the admin interface&#8212;&#8203;you can edit the node bundle that your field is attached to and toggle this setting using the new select box:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/settings-form-display.png" alt="The basic count type settings form"></span></p>
</div>
<div class="paragraph">
<p>However, you still can&#8217;t see the value of this setting in the settings summary, so finally let&#8217;s add a <code>settingsSummary</code> method to our widget class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-sd">/**</span>
<span class="tok-sd">* {@inheritdoc}</span>
<span class="tok-sd">*/</span>
<span class="tok-k">public</span> <span class="tok-k">function</span> <span class="tok-nf">settingsSummary</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-nv">$summary</span> <span class="tok-o">=</span> <span class="tok-k">parent</span><span class="tok-o">::</span><span class="tok-na">settingsSummary</span><span class="tok-p">();</span>

    <span class="tok-nv">$summary</span><span class="tok-p">[]</span> <span class="tok-o">=</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">t</span><span class="tok-p">(</span><span class="tok-s1">&#39;Shows a @count_type count&#39;</span><span class="tok-p">,</span> <span class="tok-p">[</span><span class="tok-s1">&#39;@count_type&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">getSetting</span><span class="tok-p">(</span><span class="tok-s1">&#39;count_type&#39;</span><span class="tok-p">)]);</span>

    <span class="tok-k">return</span> <span class="tok-nv">$summary</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can edit our setting on the <strong>Manage form display</strong> tab and update the stored value, have it saved in the form config, and see the settings summary updated with our selected value:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/settings-form-edit.png" alt="Editing the count type"></span></p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/settings-form-summary.png" alt="The field summary showing the count type"></span></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_generating_widgets_with_drupal_console">9. Generating widgets with Drupal console</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now we can get started by creating a module and a widget with console generation commands. If you haven’t used Drupal Console before, it gives you a bunch of scaffolding commands to generate basic plugins and components, which saves a lot of time when you’re getting up and running
(although sometimes what it generates isn’t ideal). You can see all of these commands by running <code>drupal list generate</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ drupal list generate
Drupal Console Launcher version 1.9.4
Drupal Console version 1.9.4

Available commands for the "generate" namespace:
  generate:ajax:command (gac)                 Generate &amp; Register a custom ajax command
  generate:authentication:provider (gap)      Generate an Authentication Provider
  generate:block:type (gbt)                   Generate a block content type
  generate:breakpoint (gb)                    Generate breakpoint
  generate:cache:context (gcc)                Generate a cache context
  ...</pre>
</div>
</div>
<div class="paragraph">
<p>This will give you a long list of all of the available generate commands. The two we’re interested in right now are <code>generate:module</code> and <code>generate:plugin:fieldwidget</code>.</p>
</div>
<div class="paragraph">
<p>To get started, let’s generate a module to add our Widget to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="text"><span></span>&gt; ddev drupal generate:module

 // Welcome to the Drupal module generator

 Enter the new module name:
 &gt; Example widget

 Enter the module machine name [my_module]:
 &gt;

 Enter the module Path [modules/custom]:
 &gt;

 Enter module description [My Awesome Module]:
 &gt; A module for my example widget

 Enter package name [Custom]:
 &gt;

 Enter Drupal Core version [8.x]:
 &gt;

 Do you want to generate a .module file? (yes/no) [yes]:
 &gt; yes

 Define module as feature (yes/no) [no]:
 &gt; no

 Do you want to add a composer.json file to your module? (yes/no) [yes]:
 &gt; no

 Would you like to add module dependencies? (yes/no) [no]:
 &gt; yes

 Module dependencies separated by commas (i.e. context, panels):
 &gt; text

 Do you want to generate a unit test class? (yes/no) [yes]:
 &gt; no

 Do you want to generate a themeable template? (yes/no) [yes]:
 &gt; no

 Do you want proceed with the operation? (yes/no) [yes]:
 &gt; yes</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will generate a basic module structure like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="text"><span></span>web/modules/custom/
└── example_widget
     ├── example_widget.info.yml
     └── example_widget.module</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can then generate our base widget:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="text"><span></span>web/modules/custom/
└── example_widget
    ├── example_widget.info.yml
    └── example_widget.module
    ├── example_widget.schema.yml
    └── src
        └── Plugin
            └── Field
                └── FieldWidget
                    └── ExampleWidgetFieldWidget.php <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The structure of these directories and the associated namespace is important for this to work.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This creates both a widget plugin class, and a <code>schema.yml</code> file. Let’s take a look at what’s in these.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-o">&lt;?</span><span class="tok-nx">php</span>

<span class="tok-k">namespace</span> <span class="tok-nx">Drupal\example_widget\Plugin\Field\FieldWidget</span><span class="tok-p">;</span>

<span class="tok-k">use</span> <span class="tok-nx">Drupal\Core\Field\FieldItemListInterface</span><span class="tok-p">;</span>
<span class="tok-k">use</span> <span class="tok-nx">Drupal\Core\Field\WidgetBase</span><span class="tok-p">;</span>
<span class="tok-k">use</span> <span class="tok-nx">Drupal\Core\Form\FormStateInterface</span><span class="tok-p">;</span>

<span class="tok-sd">/**</span>
<span class="tok-sd"> * Plugin implementation of the &#39;example_widget_field_widget&#39; widget.</span>
<span class="tok-sd"> *</span>
<span class="tok-sd"> * @FieldWidget(</span>
<span class="tok-sd"> *   id = &quot;example_widget_field_widget&quot;,</span>
<span class="tok-sd"> *   module = &quot;my_module&quot;,</span>
<span class="tok-sd"> *   label = @Translation(&quot;Example widget field widget&quot;),</span>
<span class="tok-sd"> *   field_types = {</span>
<span class="tok-sd"> *     &quot;string&quot;</span>
<span class="tok-sd"> *   }</span>
<span class="tok-sd"> * )</span>
<span class="tok-sd"> */</span>
<span class="tok-k">class</span> <span class="tok-nc">ExampleWidgetFieldWidget</span> <span class="tok-k">extends</span> <span class="tok-nx">WidgetBase</span> <span class="tok-p">{</span>

  <span class="tok-sd">/**</span>
<span class="tok-sd">   * {@inheritdoc}</span>
<span class="tok-sd">   */</span>
  <span class="tok-k">public</span> <span class="tok-k">static</span> <span class="tok-k">function</span> <span class="tok-nf">defaultSettings</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-k">return</span> <span class="tok-p">[</span>
      <span class="tok-s1">&#39;size&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-mi">60</span><span class="tok-p">,</span>
      <span class="tok-s1">&#39;placeholder&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;&#39;</span><span class="tok-p">,</span>
    <span class="tok-p">]</span> <span class="tok-o">+</span> <span class="tok-k">parent</span><span class="tok-o">::</span><span class="tok-na">defaultSettings</span><span class="tok-p">();</span>
  <span class="tok-p">}</span>

  <span class="tok-sd">/**</span>
<span class="tok-sd">   * {@inheritdoc}</span>
<span class="tok-sd">   */</span>
  <span class="tok-k">public</span> <span class="tok-k">function</span> <span class="tok-nf">settingsForm</span><span class="tok-p">(</span><span class="tok-k">array</span> <span class="tok-nv">$form</span><span class="tok-p">,</span> <span class="tok-nx">FormStateInterface</span> <span class="tok-nv">$form_state</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-nv">$elements</span> <span class="tok-o">=</span> <span class="tok-p">[];</span>

    <span class="tok-nv">$elements</span><span class="tok-p">[</span><span class="tok-s1">&#39;size&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
      <span class="tok-s1">&#39;#type&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;number&#39;</span><span class="tok-p">,</span>
      <span class="tok-s1">&#39;#title&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nx">t</span><span class="tok-p">(</span><span class="tok-s1">&#39;Size of textfield&#39;</span><span class="tok-p">),</span>
      <span class="tok-s1">&#39;#default_value&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">getSetting</span><span class="tok-p">(</span><span class="tok-s1">&#39;size&#39;</span><span class="tok-p">),</span>
      <span class="tok-s1">&#39;#required&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-k">TRUE</span><span class="tok-p">,</span>
      <span class="tok-s1">&#39;#min&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
    <span class="tok-p">];</span>
    <span class="tok-nv">$elements</span><span class="tok-p">[</span><span class="tok-s1">&#39;placeholder&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
      <span class="tok-s1">&#39;#type&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;textfield&#39;</span><span class="tok-p">,</span>
      <span class="tok-s1">&#39;#title&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nx">t</span><span class="tok-p">(</span><span class="tok-s1">&#39;Placeholder&#39;</span><span class="tok-p">),</span>
      <span class="tok-s1">&#39;#default_value&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">getSetting</span><span class="tok-p">(</span><span class="tok-s1">&#39;placeholder&#39;</span><span class="tok-p">),</span>
      <span class="tok-s1">&#39;#description&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nx">t</span><span class="tok-p">(</span><span class="tok-s1">&#39;Text that will be shown inside the field until a value is entered. This hint is usually a sample value or a brief description of the expected format.&#39;</span><span class="tok-p">),</span>
    <span class="tok-p">];</span>

    <span class="tok-k">return</span> <span class="tok-nv">$elements</span><span class="tok-p">;</span>
  <span class="tok-p">}</span>

  <span class="tok-sd">/**</span>
<span class="tok-sd">   * {@inheritdoc}</span>
<span class="tok-sd">   */</span>
  <span class="tok-k">public</span> <span class="tok-k">function</span> <span class="tok-nf">settingsSummary</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-nv">$summary</span> <span class="tok-o">=</span> <span class="tok-p">[];</span>

    <span class="tok-nv">$summary</span><span class="tok-p">[]</span> <span class="tok-o">=</span> <span class="tok-nx">t</span><span class="tok-p">(</span><span class="tok-s1">&#39;Textfield size: @size&#39;</span><span class="tok-p">,</span> <span class="tok-p">[</span><span class="tok-s1">&#39;@size&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">getSetting</span><span class="tok-p">(</span><span class="tok-s1">&#39;size&#39;</span><span class="tok-p">)]);</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-k">empty</span><span class="tok-p">(</span><span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">getSetting</span><span class="tok-p">(</span><span class="tok-s1">&#39;placeholder&#39;</span><span class="tok-p">)))</span> <span class="tok-p">{</span>
      <span class="tok-nv">$summary</span><span class="tok-p">[]</span> <span class="tok-o">=</span> <span class="tok-nx">t</span><span class="tok-p">(</span><span class="tok-s1">&#39;Placeholder: @placeholder&#39;</span><span class="tok-p">,</span> <span class="tok-p">[</span><span class="tok-s1">&#39;@placeholder&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">getSetting</span><span class="tok-p">(</span><span class="tok-s1">&#39;placeholder&#39;</span><span class="tok-p">)]);</span>
    <span class="tok-p">}</span>

    <span class="tok-k">return</span> <span class="tok-nv">$summary</span><span class="tok-p">;</span>
  <span class="tok-p">}</span>

  <span class="tok-sd">/**</span>
<span class="tok-sd">   * {@inheritdoc}</span>
<span class="tok-sd">   */</span>
  <span class="tok-k">public</span> <span class="tok-k">function</span> <span class="tok-nf">formElement</span><span class="tok-p">(</span><span class="tok-nx">FieldItemListInterface</span> <span class="tok-nv">$items</span><span class="tok-p">,</span> <span class="tok-nv">$delta</span><span class="tok-p">,</span> <span class="tok-k">array</span> <span class="tok-nv">$element</span><span class="tok-p">,</span> <span class="tok-k">array</span> <span class="tok-o">&amp;</span><span class="tok-nv">$form</span><span class="tok-p">,</span> <span class="tok-nx">FormStateInterface</span> <span class="tok-nv">$form_state</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-nv">$element</span><span class="tok-p">[</span><span class="tok-s1">&#39;value&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-nv">$element</span> <span class="tok-o">+</span> <span class="tok-p">[</span>
      <span class="tok-s1">&#39;#type&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;textfield&#39;</span><span class="tok-p">,</span>
      <span class="tok-s1">&#39;#default_value&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nb">isset</span><span class="tok-p">(</span><span class="tok-nv">$items</span><span class="tok-p">[</span><span class="tok-nv">$delta</span><span class="tok-p">]</span><span class="tok-o">-&gt;</span><span class="tok-na">value</span><span class="tok-p">)</span> <span class="tok-o">?</span> <span class="tok-nv">$items</span><span class="tok-p">[</span><span class="tok-nv">$delta</span><span class="tok-p">]</span><span class="tok-o">-&gt;</span><span class="tok-na">value</span> <span class="tok-o">:</span> <span class="tok-k">NULL</span><span class="tok-p">,</span>
      <span class="tok-s1">&#39;#size&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">getSetting</span><span class="tok-p">(</span><span class="tok-s1">&#39;size&#39;</span><span class="tok-p">),</span>
      <span class="tok-s1">&#39;#placeholder&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">getSetting</span><span class="tok-p">(</span><span class="tok-s1">&#39;placeholder&#39;</span><span class="tok-p">),</span>
      <span class="tok-s1">&#39;#maxlength&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">getFieldSetting</span><span class="tok-p">(</span><span class="tok-s1">&#39;max_length&#39;</span><span class="tok-p">),</span>
    <span class="tok-p">];</span>

    <span class="tok-k">return</span> <span class="tok-nv">$element</span><span class="tok-p">;</span>
  <span class="tok-p">}</span>

<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_do_widgets_work">10. How do widgets work?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Our widget is an implementation of the <code>FieldWidget</code> plugin which, if you’ve used plugins before, should look pretty familiar. First we have the annotation that defines the plugin:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-sd">/**</span>
<span class="tok-sd"> * Plugin implementation of the &#39;example_widget_field_widget&#39; widget.</span>
<span class="tok-sd"> *</span>
<span class="tok-sd"> * @FieldWidget( </span><b class="conum">(1)</b>
<span class="tok-sd"> *   id = &quot;example_widget_field_widget&quot;,</span>
<span class="tok-sd"> *   module = &quot;example_widget&quot;,</span>
<span class="tok-sd"> *   label = @Translation(&quot;Example widget field widget&quot;),</span>
<span class="tok-sd"> *   field_types = {</span>
<span class="tok-sd"> *     &quot;string&quot;</span>
<span class="tok-sd"> *   }</span>
<span class="tok-sd"> * )</span>
<span class="tok-sd"> */</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>For the full <code>@FieldWidget</code> annotation source, see <a href="https://api.drupal.org/api/drupal/core!lib!Drupal!Core!Field!Annotation!FieldWidget.php/class/FieldWidget/8.9.x">\Drupal\Core\Field\Annotation\FieldWidget</a>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Here it’s given a unique ID (prefixed with the module name), the implementing module, a translatable (human-readable) label, and a list of field types that it supports using IDs from corresponding <code>FieldType</code> plugins. Not included in this annotation are <code>multiple_values</code>, which defines whether the widget handles multiple values at once (default <code>FALSE</code>) and <code>weight</code> which alters the sorting of the widget relative to other widgets during discovery (default <code>NULL</code>).</p>
</div>
<div class="paragraph">
<p>It’s important to note that the plugin is also in a specific directory -
<code>src/Plugin/Field/FieldWidget</code>. This is both a discovery mechanism, and a useful convention that makes it easy to see what, if any, widget plugins a module implements.</p>
</div>
<div class="paragraph">
<p>After the annotation, we get into some code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-k">class</span> <span class="tok-nc">ExampleWidgetFieldWidget</span> <span class="tok-k">extends</span> <span class="tok-nx">WidgetBase</span> <span class="tok-p">{</span>
  <span class="tok-c1">//...</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The widget class extents <code>WidgetBase</code>, which in turn implements
<code>WidgetInterface</code>. The class hierarchy looks like this:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/WidgetBase.png" alt="WidgetBase class hierarchy"></span></p>
</div>
<div class="paragraph">
<p>This doesn’t really tell us much about what we need to do to make a new widget. Let’s take a look at what we need to implement from WidgetBase.
If we create a new class that extends WidgetBase, the only method from the interface that we need to implement is <code>formElement()</code>. As you can probably guess from the name, this lets us define the input form element for this field input. From <code>WidgetInterface</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span>  <span class="tok-sd">/**</span>
<span class="tok-sd">   * Returns the form for a single field widget.</span>
<span class="tok-sd">   *</span>
<span class="tok-sd">   * Field widget form elements should be based on the passed-in $element, which</span>
<span class="tok-sd">   * contains the base form element properties derived from the field</span>
<span class="tok-sd">   * configuration.</span>
<span class="tok-sd">   *</span>
<span class="tok-sd">   * The BaseWidget methods will set the weight, field name and delta values for</span>
<span class="tok-sd">   * each form element. If there are multiple values for this field, the</span>
<span class="tok-sd">   * formElement() method will be called as many times as needed.</span>
<span class="tok-sd">   *</span>
<span class="tok-sd">   * Other modules may alter the form element provided by this function using</span>
<span class="tok-sd">   * hook_field_widget_form_alter() or</span>
<span class="tok-sd">   * hook_field_widget_WIDGET_TYPE_form_alter().</span>
<span class="tok-sd">   *</span>
<span class="tok-sd">   * The FAPI element callbacks (such as #process, #element_validate,</span>
<span class="tok-sd">   * #value_callback, etc.) used by the widget do not have access to the</span>
<span class="tok-sd">   * original $field_definition passed to the widget&#39;s constructor. Therefore,</span>
<span class="tok-sd">   * if any information is needed from that definition by those callbacks, the</span>
<span class="tok-sd">   * widget implementing this method, or a</span>
<span class="tok-sd">   * hook_field_widget[_WIDGET_TYPE]_form_alter() implementation, must extract</span>
<span class="tok-sd">   * the needed properties from the field definition and set them as ad-hoc</span>
<span class="tok-sd">   * $element[&#39;#custom&#39;] properties, for later use by its element callbacks.</span>
<span class="tok-sd">   *</span>
<span class="tok-sd">   * @param \Drupal\Core\Field\FieldItemListInterface $items</span>
<span class="tok-sd">   *   Array of default values for this field.</span>
<span class="tok-sd">   * @param int $delta</span>
<span class="tok-sd">   *   The order of this item in the array of sub-elements (0, 1, 2, etc.).</span>
<span class="tok-sd">   * @param array $element</span>
<span class="tok-sd">   *   A form element array containing basic properties for the widget:</span>
<span class="tok-sd">   *   - #field_parents: The &#39;parents&#39; space for the field in the form. Most</span>
<span class="tok-sd">   *       widgets can simply overlook this property. This identifies the</span>
<span class="tok-sd">   *       location where the field values are placed within</span>
<span class="tok-sd">   *       $form_state-&gt;getValues(), and is used to access processing</span>
<span class="tok-sd">   *       information for the field through the getWidgetState() and</span>
<span class="tok-sd">   *       setWidgetState() methods.</span>
<span class="tok-sd">   *   - #title: The sanitized element label for the field, ready for output.</span>
<span class="tok-sd">   *   - #description: The sanitized element description for the field, ready</span>
<span class="tok-sd">   *     for output.</span>
<span class="tok-sd">   *   - #required: A Boolean indicating whether the element value is required;</span>
<span class="tok-sd">   *     for required multiple value fields, only the first widget&#39;s values are</span>
<span class="tok-sd">   *     required.</span>
<span class="tok-sd">   *   - #delta: The order of this item in the array of sub-elements; see $delta</span>
<span class="tok-sd">   *     above.</span>
<span class="tok-sd">   * @param array $form</span>
<span class="tok-sd">   *   The form structure where widgets are being attached to. This might be a</span>
<span class="tok-sd">   *   full form structure, or a sub-element of a larger form.</span>
<span class="tok-sd">   * @param \Drupal\Core\Form\FormStateInterface $form_state</span>
<span class="tok-sd">   *   The current state of the form.</span>
<span class="tok-sd">   *</span>
<span class="tok-sd">   * @return array</span>
<span class="tok-sd">   *   The form elements for a single widget for this field.</span>
<span class="tok-sd">   *</span>
<span class="tok-sd">   * @see hook_field_widget_form_alter()</span>
<span class="tok-sd">   * @see hook_field_widget_WIDGET_TYPE_form_alter()</span>
<span class="tok-sd">   */</span>
  <span class="tok-k">public</span> <span class="tok-k">function</span> <span class="tok-nf">formElement</span><span class="tok-p">(</span><span class="tok-nx">FieldItemListInterface</span> <span class="tok-nv">$items</span><span class="tok-p">,</span> <span class="tok-nv">$delta</span><span class="tok-p">,</span> <span class="tok-k">array</span> <span class="tok-nv">$element</span><span class="tok-p">,</span> <span class="tok-k">array</span> <span class="tok-o">&amp;</span><span class="tok-nv">$form</span><span class="tok-p">,</span> <span class="tok-nx">FormStateInterface</span> <span class="tok-nv">$form_state</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can take a few interesting facts from this method. The first is that we’re not dealing with a complete form here&#8212;&#8203;we have an <code>$element</code> which is what’s passed around to alter hooks and other methods. Although we have access to <code>$form</code> and <code>$form_state</code>, this isn’t like defining our own standalone form class where we have complete control over the parent form.</p>
</div>
<div class="paragraph">
<p>We can also see that we have access to a couple of variables which are more reminiscent of the field API than the form API--<code>$items</code> and
<code>$delta</code>. The comments tell us that <code>$items</code> represents the default values for the field (i.e. the values that are currently saved), and
<code>$delta</code> is the current value offset if we have multiple values in the field.</p>
</div>
<div class="paragraph">
<p>The reference to <code>#field_parents</code> in the <code>$element</code> is useful, and is something we’ll be coming back to in future interactions with widgets.
Since the widget form is part of an overall form, we often have to use the parent form elements to locate it in the <code>$form_state</code> array for the purposes of retrieving information about the widget. The parents also let us know what field the widget is attached to at the point that we interact with the widget in an entity context, since the widget itself is entirely agnostic of any concrete field instance.</p>
</div>
<div class="paragraph">
<p>If we jump back to our scaffolded widget we can see a basic form is defined in <code>formElement()</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span>  <span class="tok-k">public</span> <span class="tok-k">function</span> <span class="tok-nf">formElement</span><span class="tok-p">(</span><span class="tok-nx">FieldItemListInterface</span> <span class="tok-nv">$items</span><span class="tok-p">,</span> <span class="tok-nv">$delta</span><span class="tok-p">,</span> <span class="tok-k">array</span> <span class="tok-nv">$element</span><span class="tok-p">,</span> <span class="tok-k">array</span> <span class="tok-o">&amp;</span><span class="tok-nv">$form</span><span class="tok-p">,</span> <span class="tok-nx">FormStateInterface</span> <span class="tok-nv">$form_state</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-nv">$element</span><span class="tok-p">[</span><span class="tok-s1">&#39;value&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-nv">$element</span> <span class="tok-o">+</span> <span class="tok-p">[</span>
      <span class="tok-s1">&#39;#type&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;textfield&#39;</span><span class="tok-p">,</span>
      <span class="tok-s1">&#39;#default_value&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nb">isset</span><span class="tok-p">(</span><span class="tok-nv">$items</span><span class="tok-p">[</span><span class="tok-nv">$delta</span><span class="tok-p">]</span><span class="tok-o">-&gt;</span><span class="tok-na">value</span><span class="tok-p">)</span> <span class="tok-o">?</span> <span class="tok-nv">$items</span><span class="tok-p">[</span><span class="tok-nv">$delta</span><span class="tok-p">]</span><span class="tok-o">-&gt;</span><span class="tok-na">value</span> <span class="tok-o">:</span> <span class="tok-k">NULL</span><span class="tok-p">,</span>
      <span class="tok-s1">&#39;#size&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">getSetting</span><span class="tok-p">(</span><span class="tok-s1">&#39;size&#39;</span><span class="tok-p">),</span>
      <span class="tok-s1">&#39;#placeholder&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">getSetting</span><span class="tok-p">(</span><span class="tok-s1">&#39;placeholder&#39;</span><span class="tok-p">),</span>
      <span class="tok-s1">&#39;#maxlength&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">getFieldSetting</span><span class="tok-p">(</span><span class="tok-s1">&#39;max_length&#39;</span><span class="tok-p">),</span>
    <span class="tok-p">];</span>

    <span class="tok-k">return</span> <span class="tok-nv">$element</span><span class="tok-p">;</span>
  <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Most of this is standard form render element code&#8212;&#8203;if the form side isn’t familiar to you I’d recommend taking a break here and giving the <a href="https://www.drupal.org/docs/drupal-apis/form-api">Form API</a> documentation a read, particularly the section on <a href="https://www.drupal.org/docs/drupal-apis/form-api/form-render-elements">Form Render Elements</a>. Don’t worry, I’ll wait.</p>
</div>
<div class="paragraph">
<p>We can see the use of <code>$items</code> here in conjunction with <code>$delta</code> in the way we’d expect from the interface method comments&#8212;&#8203;the relevant item is retrieved using the <code>$delta</code> offset in <code>$items</code>. The magic getter <code>$items[$delta]-&gt;value</code> is used to retrieve the actual default value&#8212;&#8203;it’s important to note that the use of <code>value</code> here is not arbitrary and corresponds directly to the key name of the data in the schema (and since this is a simple widget, to the name of the form field used to set it). If we take a look at the core <code>StringItem</code> type we see this <code>schema()</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-k">public</span> <span class="tok-k">static</span> <span class="tok-k">function</span> <span class="tok-nf">schema</span><span class="tok-p">(</span><span class="tok-nx">FieldStorageDefinitionInterface</span> <span class="tok-nv">$field_definition</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-k">return</span> <span class="tok-p">[</span>
    <span class="tok-s1">&#39;columns&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-p">[</span>
      <span class="tok-s1">&#39;value&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-p">[</span>
        <span class="tok-s1">&#39;type&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$field_definition</span><span class="tok-o">-&gt;</span><span class="tok-na">getSetting</span><span class="tok-p">(</span><span class="tok-s1">&#39;is_ascii&#39;</span><span class="tok-p">)</span> <span class="tok-o">===</span> <span class="tok-k">TRUE</span> <span class="tok-o">?</span> <span class="tok-s1">&#39;varchar_ascii&#39;</span> <span class="tok-o">:</span> <span class="tok-s1">&#39;varchar&#39;</span><span class="tok-p">,</span>
        <span class="tok-s1">&#39;length&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-p">(</span><span class="tok-nx">int</span><span class="tok-p">)</span> <span class="tok-nv">$field_definition</span><span class="tok-o">-&gt;</span><span class="tok-na">getSetting</span><span class="tok-p">(</span><span class="tok-s1">&#39;max_length&#39;</span><span class="tok-p">),</span>
        <span class="tok-s1">&#39;binary&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$field_definition</span><span class="tok-o">-&gt;</span><span class="tok-na">getSetting</span><span class="tok-p">(</span><span class="tok-s1">&#39;case_sensitive&#39;</span><span class="tok-p">),</span>
      <span class="tok-p">],</span>
    <span class="tok-p">],</span>
  <span class="tok-p">];</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember earlier when I said the contract the <code>FieldWidget</code> has with the
<code>FieldType</code> is the schema? This is that contract in action.</p>
</div>
<div class="paragraph">
<p>For the rest of the form element attributes we’re getting our values from the <code>getSetting()</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-s1">&#39;#size&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">getSetting</span><span class="tok-p">(</span><span class="tok-s1">&#39;size&#39;</span><span class="tok-p">),</span>
<span class="tok-s1">&#39;#placeholder&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">getSetting</span><span class="tok-p">(</span><span class="tok-s1">&#39;placeholder&#39;</span><span class="tok-p">),</span>
<span class="tok-s1">&#39;#maxlength&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">getFieldSetting</span><span class="tok-p">(</span><span class="tok-s1">&#39;max_length&#39;</span><span class="tok-p">),</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is what the schema and the rest of the boilerplate code is for&#8212;&#8203;it manages a configuration object for this widget which allows setting and getting of configuration specific to the widget on this field instance.
The new settings defined for our widget are <code>size</code> and <code>placeholder</code>&#8201;&#8212;&#8201;<code>max_length</code> is defined on the <code>StringItem</code> class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-k">public</span> <span class="tok-k">static</span> <span class="tok-k">function</span> <span class="tok-nf">defaultStorageSettings</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-k">return</span> <span class="tok-p">[</span>
    <span class="tok-s1">&#39;max_length&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-mi">255</span><span class="tok-p">,</span>
    <span class="tok-s1">&#39;is_ascii&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-k">FALSE</span><span class="tok-p">,</span>
  <span class="tok-p">]</span> <span class="tok-o">+</span> <span class="tok-k">parent</span><span class="tok-o">::</span><span class="tok-na">defaultStorageSettings</span><span class="tok-p">();</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>(N.B. you can see the <code>is_ascii</code> setting is also defined here but doesn’t have an admin interface. This is generally defined as part of the field defaults, rather than being configurable).</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/widget_form.png" alt="Widget settings form"></span></p>
</div>
<div class="paragraph">
<p>So going back to our <code>formElement</code>, we would expect the output of this to be a text input, with these attributes defined:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-k">public</span> <span class="tok-k">function</span> <span class="tok-nf">formElement</span><span class="tok-p">(</span><span class="tok-nx">FieldItemListInterface</span> <span class="tok-nv">$items</span><span class="tok-p">,</span> <span class="tok-nv">$delta</span><span class="tok-p">,</span> <span class="tok-k">array</span> <span class="tok-nv">$element</span><span class="tok-p">,</span> <span class="tok-k">array</span> <span class="tok-o">&amp;</span><span class="tok-nv">$form</span><span class="tok-p">,</span> <span class="tok-nx">FormStateInterface</span> <span class="tok-nv">$form_state</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nv">$element</span><span class="tok-p">[</span><span class="tok-s1">&#39;value&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-nv">$element</span> <span class="tok-o">+</span> <span class="tok-p">[</span>
    <span class="tok-s1">&#39;#type&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;textfield&#39;</span><span class="tok-p">,</span>
    <span class="tok-s1">&#39;#default_value&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nb">isset</span><span class="tok-p">(</span><span class="tok-nv">$items</span><span class="tok-p">[</span><span class="tok-nv">$delta</span><span class="tok-p">]</span><span class="tok-o">-&gt;</span><span class="tok-na">value</span><span class="tok-p">)</span> <span class="tok-o">?</span> <span class="tok-nv">$items</span><span class="tok-p">[</span><span class="tok-nv">$delta</span><span class="tok-p">]</span><span class="tok-o">-&gt;</span><span class="tok-na">value</span> <span class="tok-o">:</span> <span class="tok-k">NULL</span><span class="tok-p">,</span>
    <span class="tok-s1">&#39;#size&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">getSetting</span><span class="tok-p">(</span><span class="tok-s1">&#39;size&#39;</span><span class="tok-p">),</span>
    <span class="tok-s1">&#39;#placeholder&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">getSetting</span><span class="tok-p">(</span><span class="tok-s1">&#39;placeholder&#39;</span><span class="tok-p">),</span>
    <span class="tok-s1">&#39;#maxlength&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">getFieldSetting</span><span class="tok-p">(</span><span class="tok-s1">&#39;max_length&#39;</span><span class="tok-p">),</span>
  <span class="tok-p">];</span>

  <span class="tok-k">return</span> <span class="tok-nv">$element</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can see the documentation for the <a href="https://api.drupal.org/api/drupal/core!lib!Drupal!Core!Render!Element!Textfield.php/class/Textfield/8.9.x">textfield render element</a> on Drupal.org, which outlines these properties. If we make a basic field in Drupal, we can see it outputs something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span></span><span class="tok-p">&lt;</span><span class="tok-nt">input</span>
    <span class="tok-na">data-drupal-selector</span><span class="tok-o">=</span><span class="tok-s">&quot;edit-field-plain-text-test-0-value&quot;</span>
    <span class="tok-na">type</span><span class="tok-o">=</span><span class="tok-s">&quot;text&quot;</span>
    <span class="tok-na">id</span><span class="tok-o">=</span><span class="tok-s">&quot;edit-field-plain-text-test-0-value&quot;</span>
    <span class="tok-na">name</span><span class="tok-o">=</span><span class="tok-s">&quot;field_plain_text_test[0][value]&quot;</span>
    <span class="tok-na">value</span><span class="tok-o">=</span><span class="tok-s">&quot;&quot;</span>
    <span class="tok-na">size</span><span class="tok-o">=</span><span class="tok-s">&quot;60&quot;</span>
    <span class="tok-na">maxlength</span><span class="tok-o">=</span><span class="tok-s">&quot;255&quot;</span>
    <span class="tok-na">placeholder</span><span class="tok-o">=</span><span class="tok-s">&quot;This is placeholder text&quot;</span>
    <span class="tok-na">class</span><span class="tok-o">=</span><span class="tok-s">&quot;form-text&quot;</span> <span class="tok-p">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We have the <code>size</code>, <code>max_length</code>, and <code>placeholder</code> attributes that are set on our widget, plus some other attributes generated from the name of this particular field instance.</p>
</div>
<div class="paragraph">
<p>So we’ve covered the <code>formElement()</code> method, which was the only method we had to implement on our widget class extending <code>WidgetBase</code> to satisfy <code>WidgetInterface</code>, but what about the rest of the scaffolding that was generated by drupal console? The other methods that are set on our widget class are:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-k">public</span> <span class="tok-k">static</span> <span class="tok-k">function</span> <span class="tok-nf">defaultSettings</span><span class="tok-p">()</span>
<span class="tok-k">public</span> <span class="tok-k">function</span> <span class="tok-nf">settingsForm</span><span class="tok-p">(</span><span class="tok-k">array</span> <span class="tok-nv">$form</span><span class="tok-p">,</span> <span class="tok-nx">FormStateInterface</span> <span class="tok-nv">$form_state</span><span class="tok-p">)</span>
<span class="tok-k">public</span> <span class="tok-k">function</span> <span class="tok-nf">settingsSummary</span><span class="tok-p">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We also have an <code>example_widget.schema.yml</code> file. Let’s take a look at that first, since that informs what these methods do with the settings:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">field.widget.settings.example_widget_field_widget</span><span class="tok-p tok-p-Indicator">:</span>
  <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">type</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">mapping</span>
  <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">label</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-s">&#39;Example</span><span class="tok-nv"> </span><span class="tok-s">widget</span><span class="tok-nv"> </span><span class="tok-s">field</span><span class="tok-nv"> </span><span class="tok-s">widget</span><span class="tok-nv"> </span><span class="tok-s">widget</span><span class="tok-nv"> </span><span class="tok-s">settings&#39;</span>
  <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">mapping</span><span class="tok-p tok-p-Indicator">:</span>
    <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">size</span><span class="tok-p tok-p-Indicator">:</span>
      <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">type</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">integer</span>
      <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">label</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-s">&#39;Size&#39;</span>
    <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">placeholder</span><span class="tok-p tok-p-Indicator">:</span>
      <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">type</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">textfield</span>
      <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">label</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-s">&#39;Placeholder&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We see here that a <code>mapping</code> schema is defined with two new settings -
<code>size</code> and <code>placeholder</code>--which match what we see in our widget class.
If you’re not familiar with the Schema API now is a good time to have a <a href="https://www.drupal.org/docs/drupal-apis/configuration-api/configuration-schemametadata">quick browse of the documentation</a>, but essentially what we have here is a dictionary data element which defines two named sub-elements: an integer called <code>size</code> and a textfield called <code>placeholder</code>.</p>
</div>
<div class="paragraph">
<p>These are defined in a specially-named schema
<code>field.widget.settings.example_widget_field_widget</code>, following the pattern <code>field.widget.settings.&lt;widget_id&gt;</code>. This isn’t ever invoked directly by the field widget code, and instead is part of the schema defined for the entity form display in <code>core.entity.schema.yml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yml"><span></span># Overview configuration information for form mode displays.
core.entity_form_display.*.*.*:
  type: config_entity
  label: &#39;Entity form display&#39;
  mapping:
    ...
    content:
      type: sequence
      label: &#39;Field widgets&#39;
      sequence:
        type: mapping
        label: &#39;Field widget&#39;
        mapping:
          ...
          settings:
            type: field.widget.settings.[%parent.type]
            label: &#39;Settings&#39;
          ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>This means that you’ll see your widget settings exported in the appropriate <code>core.entity_form_display.&lt;entity&gt;.&lt;bundle&gt;.&lt;view_mode&gt;</code> object for your entity form display, and you can debug the settings by querying the same object with <code>drush cget</code>.</p>
</div>
<div class="paragraph">
<p>Once we know that these are the available settings, the rest of the methods in our widget class make more sense:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-k">public</span> <span class="tok-k">static</span> <span class="tok-k">function</span> <span class="tok-nf">defaultSettings</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-k">return</span> <span class="tok-p">[</span>
    <span class="tok-s1">&#39;size&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-mi">60</span><span class="tok-p">,</span>
    <span class="tok-s1">&#39;placeholder&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;&#39;</span><span class="tok-p">,</span>
  <span class="tok-p">]</span> <span class="tok-o">+</span> <span class="tok-k">parent</span><span class="tok-o">::</span><span class="tok-na">defaultSettings</span><span class="tok-p">();</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>defaultSettings()</code> method allows us to set default values for each of the settings when the widget is created&#8212;&#8203;these are merged together with any parent values (which we can override at this stage if we’re extending an existing widget, such as with <code>is_ascii</code> as mentioned above). This is also the value which will be returned by <code>getSetting()</code> if no value is saved.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-k">public</span> <span class="tok-k">function</span> <span class="tok-nf">settingsForm</span><span class="tok-p">(</span><span class="tok-k">array</span> <span class="tok-nv">$form</span><span class="tok-p">,</span> <span class="tok-nx">FormStateInterface</span> <span class="tok-nv">$form_state</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nv">$elements</span> <span class="tok-o">=</span> <span class="tok-p">[];</span>

  <span class="tok-nv">$elements</span><span class="tok-p">[</span><span class="tok-s1">&#39;size&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
    <span class="tok-s1">&#39;#type&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;number&#39;</span><span class="tok-p">,</span>
    <span class="tok-s1">&#39;#title&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nx">t</span><span class="tok-p">(</span><span class="tok-s1">&#39;Size of textfield&#39;</span><span class="tok-p">),</span>
    <span class="tok-s1">&#39;#default_value&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">getSetting</span><span class="tok-p">(</span><span class="tok-s1">&#39;size&#39;</span><span class="tok-p">),</span>
    <span class="tok-s1">&#39;#required&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-k">TRUE</span><span class="tok-p">,</span>
    <span class="tok-s1">&#39;#min&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
  <span class="tok-p">];</span>
  <span class="tok-nv">$elements</span><span class="tok-p">[</span><span class="tok-s1">&#39;placeholder&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
    <span class="tok-s1">&#39;#type&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;textfield&#39;</span><span class="tok-p">,</span>
    <span class="tok-s1">&#39;#title&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nx">t</span><span class="tok-p">(</span><span class="tok-s1">&#39;Placeholder&#39;</span><span class="tok-p">),</span>
    <span class="tok-s1">&#39;#default_value&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">getSetting</span><span class="tok-p">(</span><span class="tok-s1">&#39;placeholder&#39;</span><span class="tok-p">),</span>
    <span class="tok-s1">&#39;#description&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nx">t</span><span class="tok-p">(</span><span class="tok-s1">&#39;Text that will be shown inside the field until a value is entered. This hint is usually a sample value or a brief description of the expected format.&#39;</span><span class="tok-p">),</span>
  <span class="tok-p">];</span>

  <span class="tok-k">return</span> <span class="tok-nv">$elements</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>settingsForm()</code> then provides the form for administrators to manage these settings. We don’t need to set our own submission function for these, just make sure the elements have the same keys as those defined in the schema.</p>
</div>
<div class="paragraph">
<p>Finally we have the <code>settingsSummary()</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-k">public</span> <span class="tok-k">function</span> <span class="tok-nf">settingsSummary</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-nv">$summary</span> <span class="tok-o">=</span> <span class="tok-p">[];</span>

  <span class="tok-nv">$summary</span><span class="tok-p">[]</span> <span class="tok-o">=</span> <span class="tok-nx">t</span><span class="tok-p">(</span><span class="tok-s1">&#39;Textfield size: @size&#39;</span><span class="tok-p">,</span> <span class="tok-p">[</span><span class="tok-s1">&#39;@size&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">getSetting</span><span class="tok-p">(</span><span class="tok-s1">&#39;size&#39;</span><span class="tok-p">)]);</span>
  <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-k">empty</span><span class="tok-p">(</span><span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">getSetting</span><span class="tok-p">(</span><span class="tok-s1">&#39;placeholder&#39;</span><span class="tok-p">)))</span> <span class="tok-p">{</span>
    <span class="tok-nv">$summary</span><span class="tok-p">[]</span> <span class="tok-o">=</span> <span class="tok-nx">t</span><span class="tok-p">(</span><span class="tok-s1">&#39;Placeholder: @placeholder&#39;</span><span class="tok-p">,</span> <span class="tok-p">[</span><span class="tok-s1">&#39;@placeholder&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">getSetting</span><span class="tok-p">(</span><span class="tok-s1">&#39;placeholder&#39;</span><span class="tok-p">)]);</span>
  <span class="tok-p">}</span>

  <span class="tok-k">return</span> <span class="tok-nv">$summary</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This defines the summary string that you see on the "Manage form display" page for an entity:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/field_summary.png" alt="Field summary on the manage form display page"></span></p>
</div>
<div class="paragraph">
<p>The one thing we don’t see for this form is any kind of validation and submission handling, but on the definition of <code>settingsForm()</code> on
<code>WidgetInterface</code> we see this comment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-o">*</span> <span class="tok-nx">Invoked</span> <span class="tok-nx">from</span> <span class="tok-nx">\Drupal\field_ui\Form\EntityDisplayFormBase</span> <span class="tok-nx">to</span> <span class="tok-nx">allow</span>
<span class="tok-o">*</span> <span class="tok-nx">administrators</span> <span class="tok-nx">to</span> <span class="tok-nx">configure</span> <span class="tok-nx">the</span> <span class="tok-nx">widget</span><span class="tok-o">.</span> <span class="tok-nx">The</span> <span class="tok-nx">field_ui</span> <span class="tok-nx">module</span> <span class="tok-nx">takes</span> <span class="tok-nx">care</span> <span class="tok-nx">of</span>
<span class="tok-o">*</span> <span class="tok-nx">handling</span> <span class="tok-nx">submitted</span> <span class="tok-nx">form</span> <span class="tok-nx">values</span><span class="tok-o">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we drop a breakpoint into our <code>settingsForm()</code> method and take a look at the <code>$form</code>, we can see the underlying form is the <a href="https://api.drupal.org/api/drupal/core%21modules%21field_ui%21src%21Form%21EntityFormDisplayEditForm.php/class/EntityFormDisplayEditForm/8.9.x"><code>EntityFormDisplayEditForm</code></a> in the <code>field_ui</code> module. This inherits from <code>EntityDisplayFormBase</code>, which defines a <code>submitForm()</code> and <code>multistepSubmit()</code> method. The default submission handler from <code>$form_state-&gt;getSubmitHandlers()</code> is <code>::multistepSubmit()</code>--the <code>submitForm()</code> method is invoked when you save the entire form display using the "Save" button.</p>
</div>
<div class="paragraph">
<p>The class does not have a validation method, so no validation is carried out on the form by default. If you want to add your own submission or validation handlers, you can alter the <code>$form_state</code> in the <code>settingsForm()</code> method to add your own for the whole form, or add validation handlers on a per-element basis with the <code>#element_validate</code> attribute.</p>
</div>
<div class="paragraph">
<p>So how do we add new handlers to the form submission? If we drop a breakpoint into the <code>multistepSubmit</code> function we can see what the triggering element is, and by using <code>#array_parents</code> figure out where it lives in the form array. If we do this for the title form element we get:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-k">array</span> <span class="tok-p">(</span>
  <span class="tok-mi">0</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;fields&#39;</span><span class="tok-p">,</span>
  <span class="tok-mi">1</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;title&#39;</span><span class="tok-p">,</span>
  <span class="tok-mi">2</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;plugin&#39;</span><span class="tok-p">,</span>
  <span class="tok-mi">3</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;settings_edit_form&#39;</span><span class="tok-p">,</span>
  <span class="tok-mi">4</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;actions&#39;</span><span class="tok-p">,</span>
  <span class="tok-mi">5</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;save_settings&#39;</span><span class="tok-p">,</span>
<span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And if we look to the form we can see this is the "Update" button for the plugin.</p>
</div>
<div class="paragraph">
<p>To edit the rows we need to check what the available field definitions are on the form display. See <code>EntityDisplayFormBase-&gt;form()</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-k">public</span> <span class="tok-k">function</span> <span class="tok-nf">form</span><span class="tok-p">(</span><span class="tok-k">array</span> <span class="tok-nv">$form</span><span class="tok-p">,</span> <span class="tok-nx">FormStateInterface</span> <span class="tok-nv">$form_state</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-nv">$form</span> <span class="tok-o">=</span> <span class="tok-k">parent</span><span class="tok-o">::</span><span class="tok-na">form</span><span class="tok-p">(</span><span class="tok-nv">$form</span><span class="tok-p">,</span> <span class="tok-nv">$form_state</span><span class="tok-p">);</span>

    <span class="tok-nv">$field_definitions</span> <span class="tok-o">=</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">getFieldDefinitions</span><span class="tok-p">();</span>
    <span class="tok-nv">$extra_fields</span> <span class="tok-o">=</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">getExtraFields</span><span class="tok-p">();</span>

    <span class="tok-c1">// ... some code omitted ...</span>

    <span class="tok-c1">// Field rows.</span>
    <span class="tok-k">foreach</span> <span class="tok-p">(</span><span class="tok-nv">$field_definitions</span> <span class="tok-k">as</span> <span class="tok-nv">$field_name</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$field_definition</span><span class="tok-p">)</span> <span class="tok-p">{</span>
      <span class="tok-nv">$table</span><span class="tok-p">[</span><span class="tok-nv">$field_name</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">buildFieldRow</span><span class="tok-p">(</span><span class="tok-nv">$field_definition</span><span class="tok-p">,</span> <span class="tok-nv">$form</span><span class="tok-p">,</span> <span class="tok-nv">$form_state</span><span class="tok-p">);</span>
    <span class="tok-p">}</span>

    <span class="tok-c1">// Non-field elements.</span>
    <span class="tok-k">foreach</span> <span class="tok-p">(</span><span class="tok-nv">$extra_fields</span> <span class="tok-k">as</span> <span class="tok-nv">$field_id</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$extra_field</span><span class="tok-p">)</span> <span class="tok-p">{</span>
      <span class="tok-nv">$table</span><span class="tok-p">[</span><span class="tok-nv">$field_id</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">buildExtraFieldRow</span><span class="tok-p">(</span><span class="tok-nv">$field_id</span><span class="tok-p">,</span> <span class="tok-nv">$extra_field</span><span class="tok-p">);</span>
    <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Can’t use this because <code>getFieldDefinitions()</code> is protected…</p>
</div>
<div class="paragraph">
<p>Can we do something with the entity to cross-reference the fields with the form? Is this available on the form object to us?</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_do_settings_work">11. How do settings work?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Our settings get loaded via <code>HtmlEntityFormController</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span>  <span class="tok-k">protected</span> <span class="tok-k">function</span> <span class="tok-nf">getFormObject</span><span class="tok-p">(</span><span class="tok-nx">RouteMatchInterface</span> <span class="tok-nv">$route_match</span><span class="tok-p">,</span> <span class="tok-nv">$form_arg</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-c1">// If no operation is provided, use &#39;default&#39;.</span>
    <span class="tok-nv">$form_arg</span> <span class="tok-o">.=</span> <span class="tok-s1">&#39;.default&#39;</span><span class="tok-p">;</span>
    <span class="tok-k">list</span> <span class="tok-p">(</span><span class="tok-nv">$entity_type_id</span><span class="tok-p">,</span> <span class="tok-nv">$operation</span><span class="tok-p">)</span> <span class="tok-o">=</span> <span class="tok-nb">explode</span><span class="tok-p">(</span><span class="tok-s1">&#39;.&#39;</span><span class="tok-p">,</span> <span class="tok-nv">$form_arg</span><span class="tok-p">);</span>

    <span class="tok-nv">$form_object</span> <span class="tok-o">=</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">entityTypeManager</span><span class="tok-o">-&gt;</span><span class="tok-na">getFormObject</span><span class="tok-p">(</span><span class="tok-nv">$entity_type_id</span><span class="tok-p">,</span> <span class="tok-nv">$operation</span><span class="tok-p">);</span>

    <span class="tok-c1">// Allow the entity form to determine the entity object from a given route</span>
    <span class="tok-c1">// match.</span>
    <span class="tok-nv">$entity</span> <span class="tok-o">=</span> <span class="tok-nv">$form_object</span><span class="tok-o">-&gt;</span><span class="tok-na">getEntityFromRouteMatch</span><span class="tok-p">(</span><span class="tok-nv">$route_match</span><span class="tok-p">,</span> <span class="tok-nv">$entity_type_id</span><span class="tok-p">);</span>
    <span class="tok-nv">$form_object</span><span class="tok-o">-&gt;</span><span class="tok-na">setEntity</span><span class="tok-p">(</span><span class="tok-nv">$entity</span><span class="tok-p">);</span>

    <span class="tok-k">return</span> <span class="tok-nv">$form_object</span><span class="tok-p">;</span>
  <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The entity is an instance of <code>EntityFormDisplay</code>. The <code>$entity_type_id</code> is <code>entity_form_display</code>, and the route name is <code>entity.entity_form_display.node.default</code>.</p>
</div>
<div class="paragraph">
<p>In <code>EntityDisplayFormBase</code> we have:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span>  <span class="tok-k">public</span> <span class="tok-k">function</span> <span class="tok-nf">getEntityFromRouteMatch</span><span class="tok-p">(</span><span class="tok-nx">RouteMatchInterface</span> <span class="tok-nv">$route_match</span><span class="tok-p">,</span> <span class="tok-nv">$entity_type_id</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-nv">$route_parameters</span> <span class="tok-o">=</span> <span class="tok-nv">$route_match</span><span class="tok-o">-&gt;</span><span class="tok-na">getParameters</span><span class="tok-p">()</span><span class="tok-o">-&gt;</span><span class="tok-na">all</span><span class="tok-p">();</span>

    <span class="tok-k">return</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">getEntityDisplay</span><span class="tok-p">(</span><span class="tok-nv">$route_parameters</span><span class="tok-p">[</span><span class="tok-s1">&#39;entity_type_id&#39;</span><span class="tok-p">],</span> <span class="tok-nv">$route_parameters</span><span class="tok-p">[</span><span class="tok-s1">&#39;bundle&#39;</span><span class="tok-p">],</span> <span class="tok-nv">$route_parameters</span><span class="tok-p">[</span><span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">displayContext</span> <span class="tok-o">.</span> <span class="tok-s1">&#39;_mode_name&#39;</span><span class="tok-p">]);</span>
  <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Where the values correspond to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>$route_parameters['entity_type_id']</code> is <code>'node'</code></p>
</li>
<li>
<p><code>$route_parameters['bundle']</code> is <code>'page'</code></p>
</li>
<li>
<p><code>$this&#8594;displayContext</code> is <code>'form'</code></p>
</li>
<li>
<p><code>$route_parameters['form_mode_name']</code> is <code>'default'</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>So the call literally resolves to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">getEntityDisplay</span><span class="tok-p">(</span><span class="tok-s1">&#39;node&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;page&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;default&#39;</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s take a look at what <code>EntityFormDisplayEditForm&#8594;getEntityDisplay()</code> does:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-k">protected</span> <span class="tok-k">function</span> <span class="tok-nf">getEntityDisplay</span><span class="tok-p">(</span><span class="tok-nv">$entity_type_id</span><span class="tok-p">,</span> <span class="tok-nv">$bundle</span><span class="tok-p">,</span> <span class="tok-nv">$mode</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-k">return</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">entityDisplayRepository</span><span class="tok-o">-&gt;</span><span class="tok-na">getFormDisplay</span><span class="tok-p">(</span><span class="tok-nv">$entity_type_id</span><span class="tok-p">,</span> <span class="tok-nv">$bundle</span><span class="tok-p">,</span> <span class="tok-nv">$mode</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Okay, that didn&#8217;t get us much further. How about <code>EntityDisplayRepository&#8594;getFormDisplay()</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span>  <span class="tok-k">public</span> <span class="tok-k">function</span> <span class="tok-nf">getFormDisplay</span><span class="tok-p">(</span><span class="tok-nv">$entity_type</span><span class="tok-p">,</span> <span class="tok-nv">$bundle</span><span class="tok-p">,</span> <span class="tok-nv">$form_mode</span> <span class="tok-o">=</span> <span class="tok-nx">self</span><span class="tok-o">::</span><span class="tok-na">DEFAULT_DISPLAY_MODE</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-nv">$storage</span> <span class="tok-o">=</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">entityTypeManager</span><span class="tok-o">-&gt;</span><span class="tok-na">getStorage</span><span class="tok-p">(</span><span class="tok-s1">&#39;entity_form_display&#39;</span><span class="tok-p">);</span>

    <span class="tok-c1">// Try loading the entity from configuration; if not found, create a fresh</span>
    <span class="tok-c1">// entity object. We do not preemptively create new entity form display</span>
    <span class="tok-c1">// configuration entries for each existing entity type and bundle whenever a</span>
    <span class="tok-c1">// new form mode becomes available. Instead, configuration entries are only</span>
    <span class="tok-c1">// created when an entity form display is explicitly configured and saved.</span>
    <span class="tok-nv">$entity_form_display</span> <span class="tok-o">=</span> <span class="tok-nv">$storage</span><span class="tok-o">-&gt;</span><span class="tok-na">load</span><span class="tok-p">(</span><span class="tok-nv">$entity_type</span> <span class="tok-o">.</span> <span class="tok-s1">&#39;.&#39;</span> <span class="tok-o">.</span> <span class="tok-nv">$bundle</span> <span class="tok-o">.</span> <span class="tok-s1">&#39;.&#39;</span> <span class="tok-o">.</span> <span class="tok-nv">$form_mode</span><span class="tok-p">);</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-nv">$entity_form_display</span><span class="tok-p">)</span> <span class="tok-p">{</span>
      <span class="tok-nv">$entity_form_display</span> <span class="tok-o">=</span> <span class="tok-nv">$storage</span><span class="tok-o">-&gt;</span><span class="tok-na">create</span><span class="tok-p">([</span>
        <span class="tok-s1">&#39;targetEntityType&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$entity_type</span><span class="tok-p">,</span>
        <span class="tok-s1">&#39;bundle&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$bundle</span><span class="tok-p">,</span>
        <span class="tok-s1">&#39;mode&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$form_mode</span><span class="tok-p">,</span>
        <span class="tok-s1">&#39;status&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-k">TRUE</span><span class="tok-p">,</span>
      <span class="tok-p">]);</span>
    <span class="tok-p">}</span>
    <span class="tok-k">return</span> <span class="tok-nv">$entity_form_display</span><span class="tok-p">;</span>
  <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we&#8217;re getting somewhere!</p>
</div>
<div class="paragraph">
<p>The first thing this does is load the <code>'entity_form_display'</code> configuration from the entityTypeManager storage. Then it loads a key based on the passed values for our type, bundle, and storage&#8212;&#8203;in our case effectively loading <code>entity_form_display.node.page.default</code>. And as we saw earlier in <code>core.entity.schema.yml</code> that we have the pattern <code>core.entity_form_display.*.*.*</code> defined for the base form schema.</p>
</div>
<div class="paragraph">
<p>What we end up with is a configuration entity with a schema corresponding to that build from <code>core.entity_form_display.*.*.*</code>, where this wildcard name is resolved as;</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[module].[config_entity_id].[entity_type_id].[bundle].[form_mode_name]</pre>
</div>
</div>
<div class="paragraph">
<p>(Where <code>form_mode_name</code> is basically the display mode).</p>
</div>
<div class="paragraph">
<p>The last part of this is in <code>$storage-&gt;create()</code>, where we see a call which literally resolves to</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-nv">$route_match</span><span class="tok-o">-&gt;</span><span class="tok-na">getParameters</span><span class="tok-p">()</span><span class="tok-o">-&gt;</span><span class="tok-na">all</span><span class="tok-p">()</span>
<span class="tok-nx">‌array</span> <span class="tok-p">(</span>
  <span class="tok-s1">&#39;form_mode_name&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;default&#39;</span><span class="tok-p">,</span>
  <span class="tok-s1">&#39;entity_type_id&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;node&#39;</span><span class="tok-p">,</span>
  <span class="tok-s1">&#39;bundle&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;page&#39;</span><span class="tok-p">,</span>
  <span class="tok-s1">&#39;node_type&#39;</span> <span class="tok-o">=&gt;</span>
  <span class="tok-nx">Drupal\node\Entity\NodeType</span><span class="tok-o">::</span><span class="tok-na">__set_state</span><span class="tok-p">(</span><span class="tok-k">array</span><span class="tok-p">(</span>
     <span class="tok-s1">&#39;type&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;page&#39;</span><span class="tok-p">,</span>
     <span class="tok-s1">&#39;name&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;Basic page&#39;</span><span class="tok-p">,</span>
     <span class="tok-s1">&#39;description&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;Use &lt;em&gt;basic pages&lt;/em&gt; for your static content, such as an \&#39;About us\&#39; page.&#39;</span><span class="tok-p">,</span>
     <span class="tok-s1">&#39;help&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;&#39;</span><span class="tok-p">,</span>
     <span class="tok-s1">&#39;new_revision&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-k">true</span><span class="tok-p">,</span>
     <span class="tok-s1">&#39;preview_mode&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
     <span class="tok-s1">&#39;display_submitted&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-k">false</span><span class="tok-p">,</span>
     <span class="tok-s1">&#39;originalId&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;page&#39;</span><span class="tok-p">,</span>
     <span class="tok-s1">&#39;status&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-k">true</span><span class="tok-p">,</span>
     <span class="tok-s1">&#39;uuid&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;207d641a-0dc0-4f00-a7cd-f3bb867fe81c&#39;</span><span class="tok-p">,</span>
     <span class="tok-s1">&#39;isUninstalling&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-k">false</span><span class="tok-p">,</span>
     <span class="tok-s1">&#39;langcode&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;en&#39;</span><span class="tok-p">,</span>
     <span class="tok-s1">&#39;third_party_settings&#39;</span> <span class="tok-o">=&gt;</span>
    <span class="tok-k">array</span> <span class="tok-p">(</span>
    <span class="tok-p">),</span>
     <span class="tok-s1">&#39;_core&#39;</span> <span class="tok-o">=&gt;</span>
    <span class="tok-k">array</span> <span class="tok-p">(</span>
      <span class="tok-s1">&#39;default_config_hash&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;KuyA4NHPXcmKAjRtwa0vQc2ZcyrUJy6IlS2TAyMNRbc&#39;</span><span class="tok-p">,</span>
    <span class="tok-p">),</span>
     <span class="tok-s1">&#39;trustedData&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-k">false</span><span class="tok-p">,</span>
     <span class="tok-s1">&#39;entityTypeId&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;node_type&#39;</span><span class="tok-p">,</span>
     <span class="tok-s1">&#39;enforceIsNew&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-k">NULL</span><span class="tok-p">,</span>
     <span class="tok-s1">&#39;typedData&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-k">NULL</span><span class="tok-p">,</span>
     <span class="tok-s1">&#39;cacheContexts&#39;</span> <span class="tok-o">=&gt;</span>
    <span class="tok-k">array</span> <span class="tok-p">(</span>
    <span class="tok-p">),</span>
     <span class="tok-s1">&#39;cacheTags&#39;</span> <span class="tok-o">=&gt;</span>
    <span class="tok-k">array</span> <span class="tok-p">(</span>
    <span class="tok-p">),</span>
     <span class="tok-s1">&#39;cacheMaxAge&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-p">,</span>
     <span class="tok-s1">&#39;_serviceIds&#39;</span> <span class="tok-o">=&gt;</span>
    <span class="tok-k">array</span> <span class="tok-p">(</span>
    <span class="tok-p">),</span>
     <span class="tok-s1">&#39;_entityStorages&#39;</span> <span class="tok-o">=&gt;</span>
    <span class="tok-k">array</span> <span class="tok-p">(</span>
    <span class="tok-p">),</span>
     <span class="tok-s1">&#39;dependencies&#39;</span> <span class="tok-o">=&gt;</span>
    <span class="tok-k">array</span> <span class="tok-p">(</span>
    <span class="tok-p">),</span>
     <span class="tok-s1">&#39;isSyncing&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-k">false</span><span class="tok-p">,</span>
  <span class="tok-p">)),</span>
<span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So the settings are resolved via the form, which has an attached <code>ConfigEntity</code>. The schema for this is built dynamically based on the widgets included in the form using the special <code>[%key]</code> and <code>[%parent]</code> placeholders. These allow the schema to reference values from the include widgets.</p>
</div>
<div class="paragraph">
<p><code>[%key]</code></p>
</div>
<div class="paragraph">
<p>If we look at some real exported config, we see:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nn">...</span>
<span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">content</span><span class="tok-p tok-p-Indicator">:</span>
  <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">...</span>
  <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">field_example_field</span><span class="tok-p tok-p-Indicator">:</span>
    <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">weight</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-s">&#39;1&#39;</span>
    <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">settings</span><span class="tok-p tok-p-Indicator">:</span>
      <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">count_type</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">letter</span>
    <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">third_party_settings</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-p tok-p-Indicator">{</span>  <span class="tok-p tok-p-Indicator">}</span>
    <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">type</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">example_widget_basic_widget</span>
    <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">region</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">content</span>
  <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This from the template schema in <code>core.entity.schema.yml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span>    <span class="tok-nx">content</span><span class="tok-o">:</span>
      <span class="tok-nx">type</span><span class="tok-o">:</span> <span class="tok-nx">sequence</span>
      <span class="tok-nx">label</span><span class="tok-o">:</span> <span class="tok-s1">&#39;Field widgets&#39;</span>
      <span class="tok-nx">sequence</span><span class="tok-o">:</span>
        <span class="tok-nx">type</span><span class="tok-o">:</span> <span class="tok-nx">mapping</span>
        <span class="tok-nx">label</span><span class="tok-o">:</span> <span class="tok-s1">&#39;Field widget&#39;</span>
        <span class="tok-nx">mapping</span><span class="tok-o">:</span>
          <span class="tok-nx">type</span><span class="tok-o">:</span>
            <span class="tok-nx">type</span><span class="tok-o">:</span> <span class="tok-nx">string</span>
            <span class="tok-nx">label</span><span class="tok-o">:</span> <span class="tok-s1">&#39;Widget type machine name&#39;</span>
          <span class="tok-nx">weight</span><span class="tok-o">:</span>
            <span class="tok-nx">type</span><span class="tok-o">:</span> <span class="tok-nx">integer</span>
            <span class="tok-nx">label</span><span class="tok-o">:</span> <span class="tok-s1">&#39;Weight&#39;</span>
          <span class="tok-nx">region</span><span class="tok-o">:</span>
            <span class="tok-nx">type</span><span class="tok-o">:</span> <span class="tok-nx">string</span>
            <span class="tok-nx">label</span><span class="tok-o">:</span> <span class="tok-s1">&#39;Region&#39;</span>
          <span class="tok-nx">settings</span><span class="tok-o">:</span>
            <span class="tok-nx">type</span><span class="tok-o">:</span> <span class="tok-nx">field</span><span class="tok-o">.</span><span class="tok-nx">widget</span><span class="tok-o">.</span><span class="tok-nx">settings</span><span class="tok-o">.</span><span class="tok-p">[</span><span class="tok-o">%</span><span class="tok-k">parent</span><span class="tok-o">.</span><span class="tok-nx">type</span><span class="tok-p">]</span>
            <span class="tok-nx">label</span><span class="tok-o">:</span> <span class="tok-s1">&#39;Settings&#39;</span>
          <span class="tok-nx">third_party_settings</span><span class="tok-o">:</span>
            <span class="tok-nx">type</span><span class="tok-o">:</span> <span class="tok-nx">sequence</span>
            <span class="tok-nx">label</span><span class="tok-o">:</span> <span class="tok-s1">&#39;Third party settings&#39;</span>
            <span class="tok-nx">sequence</span><span class="tok-o">:</span>
              <span class="tok-nx">type</span><span class="tok-o">:</span> <span class="tok-nx">field</span><span class="tok-o">.</span><span class="tok-nx">widget</span><span class="tok-o">.</span><span class="tok-nx">third_party</span><span class="tok-o">.</span><span class="tok-p">[</span><span class="tok-o">%</span><span class="tok-nb">key</span><span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For our example widget, <code>[%key]</code> resolves to <code>field_example_widget</code>, So our third-party settings would be set via a schema value of <code>field.widget.third_party.field_example_widget</code>. In practice I haven&#8217;t seen a module that uses third-party settings, but there&#8217;s a test example of this in core in the <code>field_third_party_test</code> module.</p>
</div>
<div class="paragraph">
<p>The more interesting value is <code>[%parent.type]</code>. The parent is the widget, and the type is the id of the widget plugin, so for our example widget it resolves to <code>example_widget_base_widget</code>. This will be used by all widgets, and then provides the reference back to the widget type when the settings are loaded.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_does_form_ajax_work">12. How does form AJAX work?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Because widget forms are standalone elements of a larger form, the general method of interacting with them using buttons is via AJAX actions. It is possible to add handlers to the parent form, but we then have to deal with the whole form array rather than the specific part we’re interested in for the widget, and isn&#8217;t a standard way of interacting with them in core.</p>
</div>
<div class="paragraph">
<p>Before doing any more on this, it’s worth a quick recap of the <a href="https://www.drupal.org/docs/drupal-apis/javascript-api/ajax-forms">form AJAX API</a>, since it’s something that not everyone uses a lot (myself included).</p>
</div>
<div class="paragraph">
<p>AJAX events can be added to any element that creates an event, with the general format:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-s1">&#39;#ajax&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-p">[</span>
    <span class="tok-s1">&#39;callback&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;::myAjaxCallback&#39;</span><span class="tok-p">,</span> <span class="tok-c1">// don&#39;t forget :: when calling a class method.</span>
    <span class="tok-c1">//&#39;callback&#39; =&gt; [$this, &#39;myAjaxCallback&#39;], //alternative notation</span>
    <span class="tok-s1">&#39;disable-refocus&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-k">FALSE</span><span class="tok-p">,</span> <span class="tok-c1">// Or TRUE to prevent re-focusing on the triggering element.</span>
    <span class="tok-s1">&#39;event&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;change&#39;</span><span class="tok-p">,</span>
    <span class="tok-s1">&#39;wrapper&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;edit-output&#39;</span><span class="tok-p">,</span> <span class="tok-c1">// This element is updated with this AJAX callback.</span>
    <span class="tok-s1">&#39;progress&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-p">[</span>
      <span class="tok-s1">&#39;type&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;throbber&#39;</span><span class="tok-p">,</span>
      <span class="tok-s1">&#39;message&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">t</span><span class="tok-p">(</span><span class="tok-s1">&#39;Verifying entry...&#39;</span><span class="tok-p">),</span>
    <span class="tok-p">],</span>
  <span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>See <a href="https://www.drupal.org/docs/drupal-apis/ajax-api/basic-concepts#sub_form">the AJAX form API documentation</a> for a full list of properties that can be applied to an <code>#ajax</code> attribute.</p>
</div>
<div class="paragraph">
<p>Note that an <code>#ajax</code> attribute can only have a single callback, unlike a property like <code>#submit</code> where we can attach an array of callbacks. All other callback notation applies though, so we can either attach the callback to a static class method, a method on an existing object instance, or a regular function.</p>
</div>
<div class="paragraph">
<p>We pick the event that invokes the callback, along with some properties of the AJAX response - for example, whether the element is refocussed after the callback is executed, what the progress indicator is, and what ID the element to update has.</p>
</div>
<div class="paragraph">
<p>The callback function is expected to return an <code>AjaxResponse</code>, which contains one or more commands - see <a href="https://www.drupal.org/docs/drupal-apis/ajax-api/core-ajax-callback-commands">the AJAX commands documentation</a> for a full list of the available commands. These can replace HTML, add CSS, display an alert, and many other common AJAX actions. Alternatively, you can create your own command plugin that implements the <code>CommandInterface</code>, a subject which is beyond the scope of this guide.</p>
</div>
<div class="paragraph">
<p>Essentially an <code>AjaxResponse</code> is a way of packaging a set of pre-defined configurable JavaScript actions to be executed in the DOM.</p>
</div>
<div class="paragraph">
<p>As usual, we can take a look at what core does to see some examples of
<code>#ajax</code> in widgets. In the <code>MediaLibraryWidget</code> we see a callback to open the media library modal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-nv">$element</span><span class="tok-p">[</span><span class="tok-s1">&#39;open_button&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
  <span class="tok-s1">&#39;#type&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;button&#39;</span><span class="tok-p">,</span>
  <span class="tok-s1">&#39;#value&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">t</span><span class="tok-p">(</span><span class="tok-s1">&#39;Add media&#39;</span><span class="tok-p">),</span>
  <span class="tok-s1">&#39;#name&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$field_name</span> <span class="tok-o">.</span> <span class="tok-s1">&#39;-media-library-open-button&#39;</span> <span class="tok-o">.</span> <span class="tok-nv">$id_suffix</span><span class="tok-p">,</span>
  <span class="tok-s1">&#39;#attributes&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-p">[</span>
    <span class="tok-s1">&#39;class&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-p">[</span>
      <span class="tok-s1">&#39;js-media-library-open-button&#39;</span><span class="tok-p">,</span>
    <span class="tok-p">],</span>
    <span class="tok-c1">// The jQuery UI dialog automatically moves focus to the first :tabbable</span>
    <span class="tok-c1">// element of the modal, so we need to disable refocus on the button.</span>
    <span class="tok-s1">&#39;data-disable-refocus&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;true&#39;</span><span class="tok-p">,</span>
  <span class="tok-p">],</span>
  <span class="tok-s1">&#39;#media_library_state&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$state</span><span class="tok-p">,</span>
  <span class="tok-s1">&#39;#ajax&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-p">[</span>
    <span class="tok-s1">&#39;callback&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-p">[</span><span class="tok-k">static</span><span class="tok-o">::</span><span class="tok-na">class</span><span class="tok-p">,</span> <span class="tok-s1">&#39;openMediaLibrary&#39;</span><span class="tok-p">],</span>
    <span class="tok-s1">&#39;progress&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-p">[</span>
      <span class="tok-s1">&#39;type&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;throbber&#39;</span><span class="tok-p">,</span>
      <span class="tok-s1">&#39;message&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">t</span><span class="tok-p">(</span><span class="tok-s1">&#39;Opening media library.&#39;</span><span class="tok-p">),</span>
    <span class="tok-p">],</span>
  <span class="tok-p">],</span>
  <span class="tok-c1">// Allow the media library to be opened even if there are form errors.</span>
  <span class="tok-s1">&#39;#limit_validation_errors&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-p">[],</span>
<span class="tok-p">];</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-k">public</span> <span class="tok-k">static</span> <span class="tok-k">function</span> <span class="tok-nf">openMediaLibrary</span><span class="tok-p">(</span><span class="tok-k">array</span> <span class="tok-nv">$form</span><span class="tok-p">,</span> <span class="tok-nx">FormStateInterface</span> <span class="tok-nv">$form_state</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nv">$triggering_element</span> <span class="tok-o">=</span> <span class="tok-nv">$form_state</span><span class="tok-o">-&gt;</span><span class="tok-na">getTriggeringElement</span><span class="tok-p">();</span>
  <span class="tok-nv">$library_ui</span> <span class="tok-o">=</span> <span class="tok-nx">\Drupal</span><span class="tok-o">::</span><span class="tok-na">service</span><span class="tok-p">(</span><span class="tok-s1">&#39;media_library.ui_builder&#39;</span><span class="tok-p">)</span><span class="tok-o">-&gt;</span><span class="tok-na">buildUi</span><span class="tok-p">(</span><span class="tok-nv">$triggering_element</span><span class="tok-p">[</span><span class="tok-s1">&#39;#media_library_state&#39;</span><span class="tok-p">]);</span>
  <span class="tok-nv">$dialog_options</span> <span class="tok-o">=</span> <span class="tok-nx">MediaLibraryUiBuilder</span><span class="tok-o">::</span><span class="tok-na">dialogOptions</span><span class="tok-p">();</span>
  <span class="tok-k">return</span> <span class="tok-p">(</span><span class="tok-k">new</span> <span class="tok-nx">AjaxResponse</span><span class="tok-p">())</span>
    <span class="tok-o">-&gt;</span><span class="tok-na">addCommand</span><span class="tok-p">(</span><span class="tok-k">new</span> <span class="tok-nx">OpenModalDialogCommand</span><span class="tok-p">(</span><span class="tok-nv">$dialog_options</span><span class="tok-p">[</span><span class="tok-s1">&#39;title&#39;</span><span class="tok-p">],</span> <span class="tok-nv">$library_ui</span><span class="tok-p">,</span> <span class="tok-nv">$dialog_options</span><span class="tok-p">));</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can do some validation of our form using AJAX, and return a message depending on the validity of the field content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span>  <span class="tok-k">public</span> <span class="tok-k">function</span> <span class="tok-nf">formElement</span><span class="tok-p">(</span><span class="tok-nx">FieldItemListInterface</span> <span class="tok-nv">$items</span><span class="tok-p">,</span> <span class="tok-nv">$delta</span><span class="tok-p">,</span> <span class="tok-k">array</span> <span class="tok-nv">$element</span><span class="tok-p">,</span> <span class="tok-k">array</span> <span class="tok-o">&amp;</span><span class="tok-nv">$form</span><span class="tok-p">,</span> <span class="tok-nx">FormStateInterface</span> <span class="tok-nv">$form_state</span><span class="tok-p">)</span><span class="tok-o">:</span> <span class="tok-k">array</span> <span class="tok-p">{</span>
    <span class="tok-nv">$element</span><span class="tok-p">[</span><span class="tok-s1">&#39;value&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-nb">array_merge</span><span class="tok-p">(</span><span class="tok-nv">$element</span><span class="tok-p">,</span> <span class="tok-p">[</span>
      <span class="tok-s1">&#39;#type&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;textfield&#39;</span><span class="tok-p">,</span>
      <span class="tok-s1">&#39;#default_value&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nb">isset</span><span class="tok-p">(</span><span class="tok-nv">$items</span><span class="tok-p">[</span><span class="tok-nv">$delta</span><span class="tok-p">]</span><span class="tok-o">-&gt;</span><span class="tok-na">value</span><span class="tok-p">)</span> <span class="tok-o">??</span> <span class="tok-k">NULL</span><span class="tok-p">,</span>
      <span class="tok-s1">&#39;#prefix&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;&lt;span id=&quot;foobar&quot;&gt;&#39;</span><span class="tok-p">,</span>
      <span class="tok-s1">&#39;#suffix&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;&lt;/span&gt;&#39;</span><span class="tok-p">,</span>
    <span class="tok-p">]);</span>

    <span class="tok-nv">$element</span><span class="tok-p">[</span><span class="tok-s1">&#39;submit&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
      <span class="tok-s1">&#39;#type&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;submit&#39;</span><span class="tok-p">,</span>
      <span class="tok-s1">&#39;#value&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$this</span><span class="tok-o">-&gt;</span><span class="tok-na">t</span><span class="tok-p">(</span><span class="tok-s1">&#39;Validate&#39;</span><span class="tok-p">),</span>
      <span class="tok-s1">&#39;#ajax&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-p">[</span>
        <span class="tok-s1">&#39;callback&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-p">[</span><span class="tok-k">static</span><span class="tok-o">::</span><span class="tok-na">class</span><span class="tok-p">,</span> <span class="tok-s1">&#39;doAjax&#39;</span><span class="tok-p">],</span>
        <span class="tok-s1">&#39;wrapper&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;foobar&#39;</span><span class="tok-p">,</span>
        <span class="tok-s1">&#39;progress&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-p">[</span>
          <span class="tok-s1">&#39;type&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;throbber&#39;</span><span class="tok-p">,</span>
        <span class="tok-p">]</span>
      <span class="tok-p">]</span>
    <span class="tok-p">];</span>

    <span class="tok-nv">$element</span><span class="tok-p">[</span><span class="tok-s1">&#39;#element_validate&#39;</span><span class="tok-p">][]</span> <span class="tok-o">=</span> <span class="tok-p">[</span><span class="tok-nv">$this</span><span class="tok-p">,</span> <span class="tok-s1">&#39;validateElement&#39;</span><span class="tok-p">];</span>

    <span class="tok-k">return</span> <span class="tok-nv">$element</span><span class="tok-p">;</span>
  <span class="tok-p">}</span>

  <span class="tok-k">public</span> <span class="tok-k">static</span> <span class="tok-k">function</span> <span class="tok-nf">doAjax</span><span class="tok-p">(</span><span class="tok-nv">$form</span><span class="tok-p">,</span> <span class="tok-nx">FormStateInterface</span> <span class="tok-nv">$form_state</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-sd">/** @var FormValidatorInterface $form_validator */</span>
    <span class="tok-nv">$form_validator</span> <span class="tok-o">=</span> <span class="tok-nx">\Drupal</span><span class="tok-o">::</span><span class="tok-na">service</span><span class="tok-p">(</span><span class="tok-s1">&#39;form_validator&#39;</span><span class="tok-p">);</span>
    <span class="tok-nv">$form_id</span> <span class="tok-o">=</span> <span class="tok-nv">$form_state</span><span class="tok-o">-&gt;</span><span class="tok-na">getFormObject</span><span class="tok-p">()</span><span class="tok-o">-&gt;</span><span class="tok-na">getFormId</span><span class="tok-p">();</span>
    <span class="tok-nv">$form_validator</span><span class="tok-o">-&gt;</span><span class="tok-na">validateForm</span><span class="tok-p">(</span><span class="tok-nv">$form_id</span><span class="tok-p">,</span> <span class="tok-nv">$form</span><span class="tok-p">,</span> <span class="tok-nv">$form_state</span><span class="tok-p">);</span>

    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nx">FormState</span><span class="tok-o">::</span><span class="tok-na">hasAnyErrors</span><span class="tok-p">())</span> <span class="tok-p">{</span>
      <span class="tok-nv">$message</span> <span class="tok-o">=</span> <span class="tok-nx">t</span><span class="tok-p">(</span><span class="tok-s1">&#39;Invalid&#39;</span><span class="tok-p">);</span>
      <span class="tok-nv">$type</span> <span class="tok-o">=</span> <span class="tok-nx">MessengerInterface</span><span class="tok-o">::</span><span class="tok-na">TYPE_ERROR</span><span class="tok-p">;</span>
    <span class="tok-p">}</span>
    <span class="tok-k">else</span> <span class="tok-p">{</span>
      <span class="tok-nv">$message</span> <span class="tok-o">=</span> <span class="tok-nx">t</span><span class="tok-p">(</span><span class="tok-s1">&#39;Valid&#39;</span><span class="tok-p">);</span>
      <span class="tok-nv">$type</span> <span class="tok-o">=</span> <span class="tok-nx">MessengerInterface</span><span class="tok-o">::</span><span class="tok-na">TYPE_STATUS</span><span class="tok-p">;</span>
    <span class="tok-p">}</span>

    <span class="tok-nv">$response</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">AjaxResponse</span><span class="tok-p">();</span>
    <span class="tok-nv">$response</span><span class="tok-o">-&gt;</span><span class="tok-na">addCommand</span><span class="tok-p">(</span><span class="tok-k">new</span> <span class="tok-nx">MessageCommand</span><span class="tok-p">(</span><span class="tok-nv">$message</span><span class="tok-p">,</span> <span class="tok-k">NULL</span><span class="tok-p">,</span> <span class="tok-p">[</span><span class="tok-s1">&#39;type&#39;</span>  <span class="tok-o">=&gt;</span> <span class="tok-nv">$type</span><span class="tok-p">]));</span>

    <span class="tok-k">return</span> <span class="tok-nv">$response</span><span class="tok-p">;</span>
  <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We don’t actually need to do the validation bit since the AJAX callback does that already, so the AJAX callback can be simplified to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span>  <span class="tok-k">public</span> <span class="tok-k">static</span> <span class="tok-k">function</span> <span class="tok-nf">doAjax</span><span class="tok-p">(</span><span class="tok-nv">$form</span><span class="tok-p">,</span> <span class="tok-nx">FormStateInterface</span> <span class="tok-nv">$form_state</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-nv">$triggering_element</span> <span class="tok-o">=</span> <span class="tok-nv">$form_state</span><span class="tok-o">-&gt;</span><span class="tok-na">getTriggeringElement</span><span class="tok-p">();</span>
    <span class="tok-nv">$wrapper_id</span> <span class="tok-o">=</span> <span class="tok-nv">$triggering_element</span><span class="tok-p">[</span><span class="tok-s1">&#39;#ajax&#39;</span><span class="tok-p">][</span><span class="tok-s1">&#39;wrapper&#39;</span><span class="tok-p">];</span>
    <span class="tok-nv">$parents</span> <span class="tok-o">=</span> <span class="tok-nb">array_slice</span><span class="tok-p">(</span><span class="tok-nv">$triggering_element</span><span class="tok-p">[</span><span class="tok-s1">&#39;#array_parents&#39;</span><span class="tok-p">],</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-nb">count</span><span class="tok-p">(</span><span class="tok-nv">$triggering_element</span><span class="tok-p">[</span><span class="tok-s1">&#39;#array_parents&#39;</span><span class="tok-p">])</span> <span class="tok-o">-</span> <span class="tok-mi">1</span><span class="tok-p">);</span>
    <span class="tok-nv">$element</span> <span class="tok-o">=</span> <span class="tok-nx">NestedArray</span><span class="tok-o">::</span><span class="tok-na">getValue</span><span class="tok-p">(</span><span class="tok-nv">$form</span><span class="tok-p">,</span> <span class="tok-nv">$parents</span><span class="tok-p">);</span>

    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nv">$form_state</span><span class="tok-o">-&gt;</span><span class="tok-na">getError</span><span class="tok-p">(</span><span class="tok-nv">$element</span><span class="tok-p">))</span> <span class="tok-p">{</span>
      <span class="tok-nv">$message</span> <span class="tok-o">=</span> <span class="tok-nx">t</span><span class="tok-p">(</span><span class="tok-s1">&#39;Invalid&#39;</span><span class="tok-p">);</span>
      <span class="tok-nv">$type</span> <span class="tok-o">=</span> <span class="tok-nx">MessengerInterface</span><span class="tok-o">::</span><span class="tok-na">TYPE_ERROR</span><span class="tok-p">;</span>
    <span class="tok-p">}</span>
    <span class="tok-k">else</span> <span class="tok-p">{</span>
      <span class="tok-nv">$message</span> <span class="tok-o">=</span> <span class="tok-nx">t</span><span class="tok-p">(</span><span class="tok-s1">&#39;Valid&#39;</span><span class="tok-p">);</span>
      <span class="tok-nv">$type</span> <span class="tok-o">=</span> <span class="tok-nx">MessengerInterface</span><span class="tok-o">::</span><span class="tok-na">TYPE_STATUS</span><span class="tok-p">;</span>
    <span class="tok-p">}</span>

    <span class="tok-nv">$response</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">AjaxResponse</span><span class="tok-p">();</span>
    <span class="tok-nv">$response</span><span class="tok-o">-&gt;</span><span class="tok-na">addCommand</span><span class="tok-p">(</span><span class="tok-k">new</span> <span class="tok-nx">MessageCommand</span><span class="tok-p">(</span><span class="tok-nv">$message</span><span class="tok-p">,</span> <span class="tok-k">NULL</span><span class="tok-p">,</span> <span class="tok-p">[</span><span class="tok-s1">&#39;type&#39;</span>  <span class="tok-o">=&gt;</span> <span class="tok-nv">$type</span><span class="tok-p">]));</span>
    <span class="tok-nv">$response</span><span class="tok-o">-&gt;</span><span class="tok-na">addCommand</span><span class="tok-p">(</span><span class="tok-k">new</span> <span class="tok-nx">ReplaceCommand</span><span class="tok-p">(</span><span class="tok-s2">&quot;#</span><span class="tok-si">$wrapper_id</span><span class="tok-s2">&quot;</span><span class="tok-p">,</span> <span class="tok-nv">$element</span><span class="tok-p">[</span><span class="tok-s1">&#39;value&#39;</span><span class="tok-p">]));</span>

    <span class="tok-k">return</span> <span class="tok-nv">$response</span><span class="tok-p">;</span>
  <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Take a look at <code>AjaxFormHelperTrait</code> - it has some interesting AJAX stuff for replacing the form.</p>
</div>
<div class="paragraph">
<p><a href="https://codelekhk.com/2018/07/15/drupal-8-ajax-validations-for-custom-form" class="bare">https://codelekhk.com/2018/07/15/drupal-8-ajax-validations-for-custom-form</a> <a href="https://drupal.stackexchange.com/questions/215699/how-can-i-get-the-form-validated-with-ajax" class="bare">https://drupal.stackexchange.com/questions/215699/how-can-i-get-the-form-validated-with-ajax</a></p>
</div>
<div class="paragraph">
<p>This isn’t great - the errors are divorced from the element, and we’re having to do a lot of manipulation. We could re-render the whole form if we have an error (see the <code>ajaxSubmit()</code> method on the
<code>AjaxFormHelperTrait</code>) but it would be nicer to just re-render this element with all of the error information.</p>
</div>
<div class="paragraph">
<p>In core there’s the <a href="https://www.drupal.org/docs/8/core/modules/inline-form-errors">Inline Form Errors</a> module which will let us do just that. Enable this and try re-validating our field. If you’re using ddev you can enable the module with:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>ddev drush en inline_form_errors</pre>
</div>
</div>
<div class="paragraph">
<p>We can now simplify our AJAX callback even more:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-k">public</span> <span class="tok-k">static</span> <span class="tok-k">function</span> <span class="tok-nf">doAjax</span><span class="tok-p">(</span><span class="tok-nv">$form</span><span class="tok-p">,</span> <span class="tok-nx">FormStateInterface</span> <span class="tok-nv">$form_state</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nv">$triggering_element</span> <span class="tok-o">=</span> <span class="tok-nv">$form_state</span><span class="tok-o">-&gt;</span><span class="tok-na">getTriggeringElement</span><span class="tok-p">();</span>
  <span class="tok-nv">$wrapper_id</span> <span class="tok-o">=</span> <span class="tok-nv">$triggering_element</span><span class="tok-p">[</span><span class="tok-s1">&#39;#ajax&#39;</span><span class="tok-p">][</span><span class="tok-s1">&#39;wrapper&#39;</span><span class="tok-p">];</span>
  <span class="tok-nv">$parents</span> <span class="tok-o">=</span> <span class="tok-nb">array_slice</span><span class="tok-p">(</span><span class="tok-nv">$triggering_element</span><span class="tok-p">[</span><span class="tok-s1">&#39;#array_parents&#39;</span><span class="tok-p">],</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-nb">count</span><span class="tok-p">(</span><span class="tok-nv">$triggering_element</span><span class="tok-p">[</span><span class="tok-s1">&#39;#array_parents&#39;</span><span class="tok-p">])</span> <span class="tok-o">-</span> <span class="tok-mi">1</span><span class="tok-p">);</span>
  <span class="tok-nv">$element</span> <span class="tok-o">=</span> <span class="tok-nx">NestedArray</span><span class="tok-o">::</span><span class="tok-na">getValue</span><span class="tok-p">(</span><span class="tok-nv">$form</span><span class="tok-p">,</span> <span class="tok-nv">$parents</span><span class="tok-p">);</span>

  <span class="tok-nv">$response</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">AjaxResponse</span><span class="tok-p">();</span>
  <span class="tok-nv">$response</span><span class="tok-o">-&gt;</span><span class="tok-na">addCommand</span><span class="tok-p">(</span><span class="tok-k">new</span> <span class="tok-nx">ReplaceCommand</span><span class="tok-p">(</span><span class="tok-s2">&quot;#</span><span class="tok-si">$wrapper_id</span><span class="tok-s2">&quot;</span><span class="tok-p">,</span> <span class="tok-nv">$element</span><span class="tok-p">[</span><span class="tok-s1">&#39;value&#39;</span><span class="tok-p">]));</span>

  <span class="tok-k">return</span> <span class="tok-nv">$response</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Since the AJAX processing already validates the form for us, and we want to re-render the form every time regardless of whether it’s successful
(since if there’s an error and the content is fixed, clicking validate should remove the error), this works fine for us.</p>
</div>
<div class="paragraph">
<p>There are still some things that could be made nicer here, for example adding a positive message for valid field content, but I’ll leave that as an exercise for the reader.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_third_party_settings">13. Third-party settings</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Third-party settings are a part of the form API which allows you to add your own settings options to one or more widgets using hooks. The use-case for this might be to add a global setting (like a checkbox to manage a front-end display option) to a group of widgets in your site, or to enhance a particular kind of widget without extending the class.</p>
</div>
<div class="paragraph">
<p>If you&#8217;re in a situation where the most appropriate option is to create a new widget by extending the class, this probably isn&#8217;t for you.</p>
</div>
<div class="sect2">
<h3 id="_the_api">13.1. The API</h3>
<div class="paragraph">
<p>We can find information about the interface portion of the API in <code>field_ui.api.php</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span>
<span class="tok-sd">/**</span>
<span class="tok-sd"> * Allow modules to add settings to field widgets provided by other modules.</span>
<span class="tok-sd"> *</span>
<span class="tok-sd"> * @param \Drupal\Core\Field\WidgetInterface $plugin</span>
<span class="tok-sd"> *   The instantiated field widget plugin.</span>
<span class="tok-sd"> * @param \Drupal\Core\Field\FieldDefinitionInterface $field_definition</span>
<span class="tok-sd"> *   The field definition.</span>
<span class="tok-sd"> * @param string $form_mode</span>
<span class="tok-sd"> *   The entity form mode.</span>
<span class="tok-sd"> * @param array $form</span>
<span class="tok-sd"> *   The (entire) configuration form array.</span>
<span class="tok-sd"> * @param \Drupal\Core\Form\FormStateInterface $form_state</span>
<span class="tok-sd"> *   The form state.</span>
<span class="tok-sd"> *</span>
<span class="tok-sd"> * @return array</span>
<span class="tok-sd"> *   Returns the form array to be built.</span>
<span class="tok-sd"> *</span>
<span class="tok-sd"> * @see \Drupal\field_ui\Form\EntityFormDisplayEditForm::thirdPartySettingsForm()</span>
<span class="tok-sd"> */</span>
<span class="tok-k">function</span> <span class="tok-nf">hook_field_widget_third_party_settings_form</span><span class="tok-p">(</span><span class="tok-nx">\Drupal\Core\Field\WidgetInterface</span> <span class="tok-nv">$plugin</span><span class="tok-p">,</span> <span class="tok-nx">\Drupal\Core\Field\FieldDefinitionInterface</span> <span class="tok-nv">$field_definition</span><span class="tok-p">,</span> <span class="tok-nv">$form_mode</span><span class="tok-p">,</span> <span class="tok-k">array</span> <span class="tok-nv">$form</span><span class="tok-p">,</span> <span class="tok-nx">\Drupal\Core\Form\FormStateInterface</span> <span class="tok-nv">$form_state</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nv">$element</span> <span class="tok-o">=</span> <span class="tok-p">[];</span>
  <span class="tok-c1">// Add a &#39;my_setting&#39; checkbox to the settings form for &#39;foo_widget&#39; field</span>
  <span class="tok-c1">// widgets.</span>
  <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nv">$plugin</span><span class="tok-o">-&gt;</span><span class="tok-na">getPluginId</span><span class="tok-p">()</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;foo_widget&#39;</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-nv">$element</span><span class="tok-p">[</span><span class="tok-s1">&#39;my_setting&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
      <span class="tok-s1">&#39;#type&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;checkbox&#39;</span><span class="tok-p">,</span>
      <span class="tok-s1">&#39;#title&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nx">t</span><span class="tok-p">(</span><span class="tok-s1">&#39;My setting&#39;</span><span class="tok-p">),</span>
      <span class="tok-s1">&#39;#default_value&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$plugin</span><span class="tok-o">-&gt;</span><span class="tok-na">getThirdPartySetting</span><span class="tok-p">(</span><span class="tok-s1">&#39;my_module&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;my_setting&#39;</span><span class="tok-p">),</span>
    <span class="tok-p">];</span>
  <span class="tok-p">}</span>
  <span class="tok-k">return</span> <span class="tok-nv">$element</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-sd">/**</span>
<span class="tok-sd"> * Alters the field widget settings summary.</span>
<span class="tok-sd"> *</span>
<span class="tok-sd"> * @param array $summary</span>
<span class="tok-sd"> *   An array of summary messages.</span>
<span class="tok-sd"> * @param array $context</span>
<span class="tok-sd"> *   An associative array with the following elements:</span>
<span class="tok-sd"> *   - widget: The widget object.</span>
<span class="tok-sd"> *   - field_definition: The field definition.</span>
<span class="tok-sd"> *   - form_mode: The form mode being configured.</span>
<span class="tok-sd"> *</span>
<span class="tok-sd"> * @see \Drupal\field_ui\Form\EntityFormDisplayEditForm::alterSettingsSummary()</span>
<span class="tok-sd"> */</span>
<span class="tok-k">function</span> <span class="tok-nf">hook_field_widget_settings_summary_alter</span><span class="tok-p">(</span><span class="tok-k">array</span> <span class="tok-o">&amp;</span><span class="tok-nv">$summary</span><span class="tok-p">,</span> <span class="tok-k">array</span> <span class="tok-nv">$context</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-c1">// Append a message to the summary when an instance of foo_widget has</span>
  <span class="tok-c1">// mysetting set to TRUE for the current view mode.</span>
  <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nv">$context</span><span class="tok-p">[</span><span class="tok-s1">&#39;widget&#39;</span><span class="tok-p">]</span><span class="tok-o">-&gt;</span><span class="tok-na">getPluginId</span><span class="tok-p">()</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;foo_widget&#39;</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nv">$context</span><span class="tok-p">[</span><span class="tok-s1">&#39;widget&#39;</span><span class="tok-p">]</span><span class="tok-o">-&gt;</span><span class="tok-na">getThirdPartySetting</span><span class="tok-p">(</span><span class="tok-s1">&#39;my_module&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;my_setting&#39;</span><span class="tok-p">))</span> <span class="tok-p">{</span>
      <span class="tok-nv">$summary</span><span class="tok-p">[]</span> <span class="tok-o">=</span> <span class="tok-nx">t</span><span class="tok-p">(</span><span class="tok-s1">&#39;My setting enabled.&#39;</span><span class="tok-p">);</span>
    <span class="tok-p">}</span>
  <span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that these hooks are part of the <code>field_ui</code> module, because they only affect the interface portions of managing third-party settings. Anything that implements these settings will have to use other mechanisms.</p>
</div>
<div class="paragraph">
<p>The way these interact with the widget is via the <a href="https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Core%21Config%21Entity%21ThirdPartySettingsInterface.php/interface/ThirdPartySettingsInterface/8.9.x"><code>ThirdPartySettingsInterface</code></a>--since it&#8217;s a fairly small interface, I&#8217;ll include it here for reference:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span>  <span class="tok-sd">/**</span>
<span class="tok-sd">   * Sets the value of a third-party setting.</span>
<span class="tok-sd">   *</span>
<span class="tok-sd">   * @param string $module</span>
<span class="tok-sd">   *   The module providing the third-party setting.</span>
<span class="tok-sd">   * @param string $key</span>
<span class="tok-sd">   *   The setting name.</span>
<span class="tok-sd">   * @param mixed $value</span>
<span class="tok-sd">   *   The setting value.</span>
<span class="tok-sd">   *</span>
<span class="tok-sd">   * @return $this</span>
<span class="tok-sd">   */</span>
  <span class="tok-k">public</span> <span class="tok-k">function</span> <span class="tok-nf">setThirdPartySetting</span><span class="tok-p">(</span><span class="tok-nv">$module</span><span class="tok-p">,</span> <span class="tok-nv">$key</span><span class="tok-p">,</span> <span class="tok-nv">$value</span><span class="tok-p">);</span>

  <span class="tok-sd">/**</span>
<span class="tok-sd">   * Gets the value of a third-party setting.</span>
<span class="tok-sd">   *</span>
<span class="tok-sd">   * @param string $module</span>
<span class="tok-sd">   *   The module providing the third-party setting.</span>
<span class="tok-sd">   * @param string $key</span>
<span class="tok-sd">   *   The setting name.</span>
<span class="tok-sd">   * @param mixed $default</span>
<span class="tok-sd">   *   The default value</span>
<span class="tok-sd">   *</span>
<span class="tok-sd">   * @return mixed</span>
<span class="tok-sd">   *   The value.</span>
<span class="tok-sd">   */</span>
  <span class="tok-k">public</span> <span class="tok-k">function</span> <span class="tok-nf">getThirdPartySetting</span><span class="tok-p">(</span><span class="tok-nv">$module</span><span class="tok-p">,</span> <span class="tok-nv">$key</span><span class="tok-p">,</span> <span class="tok-nv">$default</span> <span class="tok-o">=</span> <span class="tok-k">NULL</span><span class="tok-p">);</span>

  <span class="tok-sd">/**</span>
<span class="tok-sd">   * Gets all third-party settings of a given module.</span>
<span class="tok-sd">   *</span>
<span class="tok-sd">   * @param string $module</span>
<span class="tok-sd">   *   The module providing the third-party settings.</span>
<span class="tok-sd">   *</span>
<span class="tok-sd">   * @return array</span>
<span class="tok-sd">   *   An array of key-value pairs.</span>
<span class="tok-sd">   */</span>
  <span class="tok-k">public</span> <span class="tok-k">function</span> <span class="tok-nf">getThirdPartySettings</span><span class="tok-p">(</span><span class="tok-nv">$module</span><span class="tok-p">);</span>

  <span class="tok-sd">/**</span>
<span class="tok-sd">   * Unsets a third-party setting.</span>
<span class="tok-sd">   *</span>
<span class="tok-sd">   * @param string $module</span>
<span class="tok-sd">   *   The module providing the third-party setting.</span>
<span class="tok-sd">   * @param string $key</span>
<span class="tok-sd">   *   The setting name.</span>
<span class="tok-sd">   *</span>
<span class="tok-sd">   * @return mixed</span>
<span class="tok-sd">   *   The value.</span>
<span class="tok-sd">   */</span>
  <span class="tok-k">public</span> <span class="tok-k">function</span> <span class="tok-nf">unsetThirdPartySetting</span><span class="tok-p">(</span><span class="tok-nv">$module</span><span class="tok-p">,</span> <span class="tok-nv">$key</span><span class="tok-p">);</span>

  <span class="tok-sd">/**</span>
<span class="tok-sd">   * Gets the list of third parties that store information.</span>
<span class="tok-sd">   *</span>
<span class="tok-sd">   * @return array</span>
<span class="tok-sd">   *   The list of third parties.</span>
<span class="tok-sd">   */</span>
  <span class="tok-k">public</span> <span class="tok-k">function</span> <span class="tok-nf">getThirdPartyProviders</span><span class="tok-p">();</span>

<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This interface is very simple, and creates a contract for how a class should get and set third-party settings from other code outside of the implementing module. For our purposes, this is implemented by <code>PluginBase</code> (which is then extended by <code>WidgetBase</code>).</p>
</div>
<div class="paragraph">
<p>The form itself is surfaced by <code>EntityDisplayFormBase</code> as part of the <code>buildFieldRow()</code> method&#8212;&#8203;this retrieves both the settings form and and third-party settings forms for the widget, then renders them out.</p>
</div>
<div class="paragraph">
<p>The settings are loaded with the configuration entity in</p>
</div>
<div class="paragraph">
<p>We can create our own example of a module that adds some third-party settings to a widget. Let&#8217;s take the <code>StringTextfieldWidget</code> and add a setting that appends a variable number of exclamation marks to the text.</p>
</div>
<div class="paragraph">
<p>As with our field widget settings, we need a schema that these settings will adhere to. We can look back at our exploration of the form configuration entity schema to figure out what name this should have:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span>    <span class="tok-nx">content</span><span class="tok-o">:</span>
      <span class="tok-nx">type</span><span class="tok-o">:</span> <span class="tok-nx">sequence</span>
      <span class="tok-nx">label</span><span class="tok-o">:</span> <span class="tok-s1">&#39;Field widgets&#39;</span>
      <span class="tok-nx">sequence</span><span class="tok-o">:</span>
        <span class="tok-nx">type</span><span class="tok-o">:</span> <span class="tok-nx">mapping</span>
        <span class="tok-nx">label</span><span class="tok-o">:</span> <span class="tok-s1">&#39;Field widget&#39;</span>
        <span class="tok-nx">mapping</span><span class="tok-o">:</span>
          <span class="tok-nx">type</span><span class="tok-o">:</span>
            <span class="tok-nx">type</span><span class="tok-o">:</span> <span class="tok-nx">string</span>
            <span class="tok-nx">label</span><span class="tok-o">:</span> <span class="tok-s1">&#39;Widget type machine name&#39;</span>
          <span class="tok-nx">weight</span><span class="tok-o">:</span>
            <span class="tok-nx">type</span><span class="tok-o">:</span> <span class="tok-nx">integer</span>
            <span class="tok-nx">label</span><span class="tok-o">:</span> <span class="tok-s1">&#39;Weight&#39;</span>
          <span class="tok-nx">region</span><span class="tok-o">:</span>
            <span class="tok-nx">type</span><span class="tok-o">:</span> <span class="tok-nx">string</span>
            <span class="tok-nx">label</span><span class="tok-o">:</span> <span class="tok-s1">&#39;Region&#39;</span>
          <span class="tok-nx">settings</span><span class="tok-o">:</span>
            <span class="tok-nx">type</span><span class="tok-o">:</span> <span class="tok-nx">field</span><span class="tok-o">.</span><span class="tok-nx">widget</span><span class="tok-o">.</span><span class="tok-nx">settings</span><span class="tok-o">.</span><span class="tok-p">[</span><span class="tok-o">%</span><span class="tok-k">parent</span><span class="tok-o">.</span><span class="tok-nx">type</span><span class="tok-p">]</span>
            <span class="tok-nx">label</span><span class="tok-o">:</span> <span class="tok-s1">&#39;Settings&#39;</span>
          <span class="tok-nx">third_party_settings</span><span class="tok-o">:</span>
            <span class="tok-nx">type</span><span class="tok-o">:</span> <span class="tok-nx">sequence</span>
            <span class="tok-nx">label</span><span class="tok-o">:</span> <span class="tok-s1">&#39;Third party settings&#39;</span>
            <span class="tok-nx">sequence</span><span class="tok-o">:</span>
              <span class="tok-nx">type</span><span class="tok-o">:</span> <span class="tok-nx">field</span><span class="tok-o">.</span><span class="tok-nx">widget</span><span class="tok-o">.</span><span class="tok-nx">third_party</span><span class="tok-o">.</span><span class="tok-p">[</span><span class="tok-o">%</span><span class="tok-nb">key</span><span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So a third-party setting schema has the name <code>field.widget.third_party.[%key]</code>, where <code>[%key]</code> is the widget id as that&#8217;s the settings key for the widget.</p>
</div>
<div class="paragraph">
<p>So, for our third-party settings, let&#8217;s add a field for "colour":</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">field.widget.third_party.string_textfield</span><span class="tok-p tok-p-Indicator">:</span>
  <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">type</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-s">&#39;Mapping&#39;</span>
  <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">label</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-s">&#39;Third</span><span class="tok-nv"> </span><span class="tok-s">party</span><span class="tok-nv"> </span><span class="tok-s">settings</span><span class="tok-nv"> </span><span class="tok-s">for</span><span class="tok-nv"> </span><span class="tok-s">string</span><span class="tok-nv"> </span><span class="tok-s">widget&#39;</span>
  <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">mapping</span><span class="tok-p tok-p-Indicator">:</span>
    <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">colour</span><span class="tok-p tok-p-Indicator">:</span>
      <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">type</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">string</span>
      <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">label</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-s">&#39;Field</span><span class="tok-nv"> </span><span class="tok-s">widget</span><span class="tok-nv"> </span><span class="tok-s">colour&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we need to add the matching settings form. This should all be familiar from adding a regular settings form for a widget, except this time we&#8217;re doing it with hooks:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-sd">/**</span>
<span class="tok-sd"> * Implements hook_field_widget_third_party_settings_form().</span>
<span class="tok-sd"> */</span>
<span class="tok-k">function</span> <span class="tok-nf">foobar_field_widget_third_party_settings_form</span><span class="tok-p">(</span><span class="tok-nx">\Drupal\Core\Field\WidgetInterface</span> <span class="tok-nv">$plugin</span><span class="tok-p">,</span> <span class="tok-nx">\Drupal\Core\Field\FieldDefinitionInterface</span> <span class="tok-nv">$field_definition</span><span class="tok-p">,</span> <span class="tok-nv">$form_mode</span><span class="tok-p">,</span> <span class="tok-k">array</span> <span class="tok-nv">$form</span><span class="tok-p">,</span> <span class="tok-nx">\Drupal\Core\Form\FormStateInterface</span> <span class="tok-nv">$form_state</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nv">$plugin</span><span class="tok-o">-&gt;</span><span class="tok-na">getPluginId</span><span class="tok-p">()</span> <span class="tok-o">===</span> <span class="tok-s1">&#39;string_textfield&#39;</span> <span class="tok-o">&amp;&amp;</span> <span class="tok-nv">$plugin</span><span class="tok-o">-&gt;</span><span class="tok-na">getThirdPartySetting</span><span class="tok-p">(</span><span class="tok-s1">&#39;foobar&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;colour&#39;</span><span class="tok-p">))</span> <span class="tok-p">{</span>
    <span class="tok-nv">$element</span><span class="tok-p">[</span><span class="tok-s1">&#39;colour&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
      <span class="tok-s1">&#39;#type&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;textfield&#39;</span><span class="tok-p">,</span>
      <span class="tok-s1">&#39;#title&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nx">t</span><span class="tok-p">(</span><span class="tok-s1">&#39;Colour&#39;</span><span class="tok-p">),</span>
      <span class="tok-s1">&#39;#default_value&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$plugin</span><span class="tok-o">-&gt;</span><span class="tok-na">getThirdPartySetting</span><span class="tok-p">(</span><span class="tok-s1">&#39;foobar&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;colour&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;none&#39;</span><span class="tok-p">),</span>
    <span class="tok-p">];</span>

    <span class="tok-k">return</span> <span class="tok-nv">$element</span><span class="tok-p">;</span>
  <span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This hook gets called for all plugins, so we check the plugin ID (<code>$plugin</code> here is the current instance of the widget class) then set the form element if it&#8217;s the one we&#8217;re after. You&#8217;ll see we&#8217;re using one of the <code>ThirdPartySettingsInterface</code> methods to retrieve the value of the setting from the widget class.</p>
</div>
<div class="paragraph">
<p>The final part of the interface implementation is to add the field value to the settings summary:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-sd">/**</span>
<span class="tok-sd"> * Implements hook_field_widget_settings_summary_alter().</span>
<span class="tok-sd"> */</span>
<span class="tok-k">function</span> <span class="tok-nf">foobar_field_widget_settings_summary_alter</span><span class="tok-p">(</span><span class="tok-k">array</span> <span class="tok-o">&amp;</span><span class="tok-nv">$summary</span><span class="tok-p">,</span> <span class="tok-k">array</span> <span class="tok-nv">$context</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-sd">/** @var \Drupal\Core\Field\WidgetInterface $widget */</span>
  <span class="tok-nv">$widget</span> <span class="tok-o">=</span> <span class="tok-nv">$context</span><span class="tok-p">[</span><span class="tok-s1">&#39;widget&#39;</span><span class="tok-p">];</span>

  <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nv">$widget</span><span class="tok-o">-&gt;</span><span class="tok-na">getPluginId</span><span class="tok-p">()</span> <span class="tok-o">===</span> <span class="tok-s1">&#39;string_textfield&#39;</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-nv">$summary</span><span class="tok-p">[]</span> <span class="tok-o">=</span> <span class="tok-nx">t</span><span class="tok-p">(</span><span class="tok-s1">&#39;Colour: @colour&#39;</span><span class="tok-p">,</span> <span class="tok-p">[</span><span class="tok-s1">&#39;@colour&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">$widget</span><span class="tok-o">-&gt;</span><span class="tok-na">getThirdPartySetting</span><span class="tok-p">(</span><span class="tok-s1">&#39;foobar&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;colour&#39;</span><span class="tok-p">)]);</span>
  <span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You&#8217;ll see that we haven&#8217;t added a default setting anywhere in the same way we would with a <code>defaultSettings()</code> method in the widget class. Unfortunately it looks like at this time this isn&#8217;t possible without altering the parent form, so the default will be that the widget has no value until the settings form is first saved. You may therefore have to take this into account in any code that uses the settings later on.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_implementation">13.2. The implementation</h3>
<div class="paragraph">
<p>We&#8217;ve now added our settings, and we can retrieve them from the widget object with <code>getThirdPartySetting</code>. So how do we make them affect our widget display?</p>
</div>
<div class="paragraph">
<p>For this we turn to <code>hook_field_widget_form_alter()</code>. From <code>field.api.php</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-sd">/**</span>
<span class="tok-sd"> * Alter forms for field widgets provided by other modules.</span>
<span class="tok-sd"> *</span>
<span class="tok-sd"> * This hook can only modify individual elements within a field widget and</span>
<span class="tok-sd"> * cannot alter the top level (parent element) for multi-value fields. In most</span>
<span class="tok-sd"> * cases, you should use hook_field_widget_multivalue_form_alter() instead and</span>
<span class="tok-sd"> * loop over the elements.</span>
<span class="tok-sd"> *</span>
<span class="tok-sd"> * @param $element</span>
<span class="tok-sd"> *   The field widget form element as constructed by</span>
<span class="tok-sd"> *   \Drupal\Core\Field\WidgetBaseInterface::form().</span>
<span class="tok-sd"> * @param $form_state</span>
<span class="tok-sd"> *   The current state of the form.</span>
<span class="tok-sd"> * @param $context</span>
<span class="tok-sd"> *   An associative array containing the following key-value pairs:</span>
<span class="tok-sd"> *   - form: The form structure to which widgets are being attached. This may be</span>
<span class="tok-sd"> *     a full form structure, or a sub-element of a larger form.</span>
<span class="tok-sd"> *   - widget: The widget plugin instance.</span>
<span class="tok-sd"> *   - items: The field values, as a</span>
<span class="tok-sd"> *     \Drupal\Core\Field\FieldItemListInterface object.</span>
<span class="tok-sd"> *   - delta: The order of this item in the array of subelements (0, 1, 2, etc).</span>
<span class="tok-sd"> *   - default: A boolean indicating whether the form is being shown as a dummy</span>
<span class="tok-sd"> *     form to set default values.</span>
<span class="tok-sd"> *</span>
<span class="tok-sd"> * @see \Drupal\Core\Field\WidgetBaseInterface::form()</span>
<span class="tok-sd"> * @see \Drupal\Core\Field\WidgetBase::formSingleElement()</span>
<span class="tok-sd"> * @see hook_field_widget_WIDGET_TYPE_form_alter()</span>
<span class="tok-sd"> * @see hook_field_widget_multivalue_form_alter()</span>
<span class="tok-sd"> */</span>
<span class="tok-k">function</span> <span class="tok-nf">hook_field_widget_form_alter</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-nv">$element</span><span class="tok-p">,</span> <span class="tok-nx">\Drupal\Core\Form\FormStateInterface</span> <span class="tok-nv">$form_state</span><span class="tok-p">,</span> <span class="tok-nv">$context</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-c1">// Add a css class to widget form elements for all fields of type mytype.</span>
  <span class="tok-nv">$field_definition</span> <span class="tok-o">=</span> <span class="tok-nv">$context</span><span class="tok-p">[</span><span class="tok-s1">&#39;items&#39;</span><span class="tok-p">]</span><span class="tok-o">-&gt;</span><span class="tok-na">getFieldDefinition</span><span class="tok-p">();</span>
  <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nv">$field_definition</span><span class="tok-o">-&gt;</span><span class="tok-na">getType</span><span class="tok-p">()</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;mytype&#39;</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-c1">// Be sure not to overwrite existing attributes.</span>
    <span class="tok-nv">$element</span><span class="tok-p">[</span><span class="tok-s1">&#39;#attributes&#39;</span><span class="tok-p">][</span><span class="tok-s1">&#39;class&#39;</span><span class="tok-p">][]</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;myclass&#39;</span><span class="tok-p">;</span>
  <span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you&#8217;ve been paying attention, you&#8217;ll see that we&#8217;ve switched module APIs&#8212;&#8203;since we&#8217;re no longer dealing with the UI portion of the widget, and instead are changing the widget itself, we&#8217;re now in the Field API. This means that, if your custom setting is set, it will apply even when the Field UI module is disabled (as you&#8217;d expect).</p>
</div>
<div class="paragraph">
<p>Let&#8217;s add a hook to alter our widget form:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-sd">/**</span>
<span class="tok-sd"> * Implements hook_field_widget_form_alter().</span>
<span class="tok-sd"> */</span>
<span class="tok-k">function</span> <span class="tok-nf">foobar_field_widget_form_alter</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-nv">$element</span><span class="tok-p">,</span> <span class="tok-nx">\Drupal\Core\Form\FormStateInterface</span> <span class="tok-nv">$form_state</span><span class="tok-p">,</span> <span class="tok-nv">$context</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-sd">/** @var \Drupal\Core\Field\WidgetBaseInterface $widget */</span>
  <span class="tok-nv">$widget</span> <span class="tok-o">=</span> <span class="tok-nv">$context</span><span class="tok-p">[</span><span class="tok-s1">&#39;widget&#39;</span><span class="tok-p">];</span>

  <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nv">$widget</span><span class="tok-o">-&gt;</span><span class="tok-na">getPluginId</span><span class="tok-p">()</span> <span class="tok-o">===</span> <span class="tok-s1">&#39;string_textfield&#39;</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-c1">// @todo do this with proper attached styles</span>
    <span class="tok-nv">$element</span><span class="tok-p">[</span><span class="tok-s1">&#39;value&#39;</span><span class="tok-p">][</span><span class="tok-s1">&#39;#attributes&#39;</span><span class="tok-p">][</span><span class="tok-s1">&#39;style&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;color: &#39;</span> <span class="tok-o">.</span><span class="tok-nv">$widget</span><span class="tok-o">-&gt;</span><span class="tok-na">getThirdPartySetting</span><span class="tok-p">(</span><span class="tok-s1">&#39;foobar&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;colour&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;inherit&#39;</span><span class="tok-p">)</span> <span class="tok-o">.</span> <span class="tok-s1">&#39;;&#39;</span><span class="tok-p">;</span>
  <span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_appendix">14. Appendix</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_form_api_primer">14.1. Form API primer</h3>

</div>
<div class="sect2">
<h3 id="_render_element_primer">14.2. Render element primer</h3>

</div>
<div class="sect2">
<h3 id="_ddev_environment">14.3. ddev environment</h3>
<div class="paragraph">
<p>I’m assuming you already have a basic Drupal 8 environment set up&#8212;&#8203;if not, the easiest way to get started is with the ddev installer&#8212;&#8203;go ahead, I’ll wait.</p>
</div>
<div class="paragraph">
<p>Once you have your Drupal environment set up, go ahead and install Drupal console with <code>ddev composer install --dev drupal/console</code> omit the <code>ddev</code> if you’re using something else). If you are using ddev, we can make life a bit easier by adding a ddev command so that you can invoke the console from your host machine. In the <code>.ddev/commands/web</code> directory, create a file called <code>drupal</code> with the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-ch">#!/bin/bash</span>

/var/www/html/vendor/bin/drupal <span class="tok-s2">&quot;</span><span class="tok-nv">$@</span><span class="tok-s2">&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Make it executable with <code>chmod 775 .ddev/commands/web/drupal</code>, and you should be able to run <code>ddev drupal</code> and get the output from Drupal console on the ddev container.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_errata">15. Errata</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you spot any issues with the content of this ebook, please let me know so I can correct it accordingly. Send an email to <a href="mailto:ben@benkyriakou.com">ben@benkyriakou.com</a> with the details of the issue, your edition version, and the page it appears on. Thanks!</p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 0.1<br>
Last updated 2021-01-03 16:17:21 UTC
</div>
</div>
<style>
pre.pygments .hll { background-color: #ffffcc }
pre.pygments  { background: #f8f8f8; }
pre.pygments .tok-c { color: #408080; font-style: italic } /* Comment */
pre.pygments .tok-err { border: 1px solid #FF0000 } /* Error */
pre.pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
pre.pygments .tok-o { color: #666666 } /* Operator */
pre.pygments .tok-ch { color: #408080; font-style: italic } /* Comment.Hashbang */
pre.pygments .tok-cm { color: #408080; font-style: italic } /* Comment.Multiline */
pre.pygments .tok-cp { color: #BC7A00 } /* Comment.Preproc */
pre.pygments .tok-cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
pre.pygments .tok-c1 { color: #408080; font-style: italic } /* Comment.Single */
pre.pygments .tok-cs { color: #408080; font-style: italic } /* Comment.Special */
pre.pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
pre.pygments .tok-ge { font-style: italic } /* Generic.Emph */
pre.pygments .tok-gr { color: #FF0000 } /* Generic.Error */
pre.pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
pre.pygments .tok-gi { color: #00A000 } /* Generic.Inserted */
pre.pygments .tok-go { color: #888888 } /* Generic.Output */
pre.pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
pre.pygments .tok-gs { font-weight: bold } /* Generic.Strong */
pre.pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
pre.pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
pre.pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
pre.pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
pre.pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
pre.pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
pre.pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
pre.pygments .tok-kt { color: #B00040 } /* Keyword.Type */
pre.pygments .tok-m { color: #666666 } /* Literal.Number */
pre.pygments .tok-s { color: #BA2121 } /* Literal.String */
pre.pygments .tok-na { color: #7D9029 } /* Name.Attribute */
pre.pygments .tok-nb { color: #008000 } /* Name.Builtin */
pre.pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
pre.pygments .tok-no { color: #880000 } /* Name.Constant */
pre.pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
pre.pygments .tok-ni { color: #999999; font-weight: bold } /* Name.Entity */
pre.pygments .tok-ne { color: #D2413A; font-weight: bold } /* Name.Exception */
pre.pygments .tok-nf { color: #0000FF } /* Name.Function */
pre.pygments .tok-nl { color: #A0A000 } /* Name.Label */
pre.pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
pre.pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
pre.pygments .tok-nv { color: #19177C } /* Name.Variable */
pre.pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
pre.pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
pre.pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
pre.pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
pre.pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
pre.pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
pre.pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
pre.pygments .tok-sa { color: #BA2121 } /* Literal.String.Affix */
pre.pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
pre.pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
pre.pygments .tok-dl { color: #BA2121 } /* Literal.String.Delimiter */
pre.pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
pre.pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
pre.pygments .tok-se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
pre.pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
pre.pygments .tok-si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
pre.pygments .tok-sx { color: #008000 } /* Literal.String.Other */
pre.pygments .tok-sr { color: #BB6688 } /* Literal.String.Regex */
pre.pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
pre.pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
pre.pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
pre.pygments .tok-fm { color: #0000FF } /* Name.Function.Magic */
pre.pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
pre.pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
pre.pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
pre.pygments .tok-vm { color: #19177C } /* Name.Variable.Magic */
pre.pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */
</style>
</body>
</html>